<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Screen Deck">
  <title>Screen Deck</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=1wXXnWU1jUCjajzlGiuNhP1kQxm53_9Lc">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --gold: #d4af37;
      --gold-light: #f4e5b8;
      --gold-dark: #b8941f;
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body { 
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: #fff; 
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* ËÉåÊôØ„Ç®„Éï„Çß„ÇØ„Éà */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(212, 175, 55, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 69, 19, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    main {
      position: relative;
      z-index: 1;
    }

    /* „Çø„Ç§„Éù„Ç∞„É©„Éï„Ç£ */
    h1, h2, h3, .title-font {
      font-family: 'Playfair Display', serif;
      letter-spacing: -0.02em;
    }

    .logo-text {
      font-family: 'Playfair Display', serif;
      font-weight: 900;
      font-size: 2rem;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 40px rgba(212, 175, 55, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logo-text:hover {
      text-shadow: 0 0 60px rgba(212, 175, 55, 0.4);
    }

    /* „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
    .glass-nav { 
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* „Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
    .btn-filter {
      padding: 0.6rem 1.2rem;
      border-radius: 24px;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(212, 175, 55, 0.2);
      color: #fff;
      cursor: pointer;
      backdrop-filter: blur(10px);
    }

    .btn-filter:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(212, 175, 55, 0.4);
      transform: translateY(-2px);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      color: #000;
      border: none;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
      font-weight: 700;
    }

    .btn-primary:hover {
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
      transform: translateY(-3px);
    }

    /* „Éö„Éº„Ç∏„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
    .page-indicator {
      font-family: 'Inter', monospace;
      color: #999;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .page-indicator:hover {
      color: var(--gold);
      transform: scale(1.05);
    }

    /* Êò†Áîª„Ç´„Éº„Éâ */
    .movie-card { 
      position: relative;
      cursor: pointer;
      animation: cardFadeIn 0.6s ease-out both;
      animation-delay: calc(var(--card-index) * 0.05s);
    }

    @keyframes cardFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .movie-card-wrapper {
      position: relative;
      aspect-ratio: 2/3;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .movie-card:active .movie-card-wrapper { 
      transform: scale(0.95); 
    }

    @media (min-width: 768px) {
      .movie-card:hover .movie-card-wrapper { 
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 16px 48px rgba(212, 175, 55, 0.3);
      }
    }

    .movie-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.4s ease;
    }

    .movie-card:hover img {
      transform: scale(1.05);
    }

    /* Ë¶ñËÅ¥Ê∏à„Åø„Éê„ÉÉ„Ç∏ */
    .watched-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(212, 175, 55, 0.95);
      color: #000;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.125rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    @media (min-width: 1024px) {
      .watched-badge {
        width: 1.75rem;
        height: 1.75rem;
        font-size: 0.875rem;
      }
    }

    /* Êò†Áîª„Ç™„Éº„Éê„Éº„É¨„Ç§ */
    .movie-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 60%);
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 1rem;
    }

    @media (min-width: 768px) {
      .movie-card:hover .movie-overlay {
        opacity: 1;
      }
    }

    .movie-title {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 1rem;
      margin-top: 0.75rem;
      margin-bottom: 0.25rem;
      line-height: 1.3;
    }

    .movie-year {
      color: #999;
      font-size: 0.875rem;
    }

    /* „Éï„Ç£„É´„Çø„Éº„Éë„Éç„É´ */
    .filter-panel {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(212, 175, 55, 0.2);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      backdrop-filter: blur(10px);
      margin-bottom: 1.5rem;
    }

    .filter-label {
      color: var(--gold);
      font-weight: 600;
      margin-right: 0.5rem;
    }

    .filter-value {
      color: #fff;
      font-weight: 700;
    }

    .filter-clear {
      color: #666;
      transition: color 0.2s ease;
      cursor: pointer;
    }

    .filter-clear:hover {
      color: var(--gold);
    }

    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Ç±„É´„Éà„É≥ */
    .skeleton-card {
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .skeleton-poster {
      aspect-ratio: 2/3;
      background: linear-gradient(90deg, 
        rgba(255,255,255,0.05) 0%, 
        rgba(255,255,255,0.1) 50%, 
        rgba(255,255,255,0.05) 100%);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
      border-radius: 12px;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .skeleton-title {
      height: 1rem;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      margin-top: 0.75rem;
      width: 80%;
    }

    .skeleton-meta {
      height: 0.75rem;
      background: rgba(255,255,255,0.07);
      border-radius: 4px;
      margin-top: 0.5rem;
      width: 50%;
    }

    /* „É¢„Éº„ÉÄ„É´ */
    #modal {
      backdrop-filter: blur(8px);
    }

    .modal-content {
      animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modalSlideUp {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-close {
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: rgba(212, 175, 55, 0.95);
      color: #000;
      transform: rotate(90deg);
    }

    .status-unwatched {
      background: rgba(255, 59, 48, 0.2);
      color: #ff3b30;
      border: 1px solid #ff3b30;
    }

    .status-watched {
      background: rgba(212, 175, 55, 0.2);
      color: var(--gold);
      border: 1px solid var(--gold);
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Ç∞„É™„ÉÉ„ÉâÊîπÂñÑ */
    .movie-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    @media (min-width: 640px) {
      .movie-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 1.25rem;
      }
    }

    @media (min-width: 1024px) {
      .movie-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
      }
    }

    @media (min-width: 1280px) {
      .movie-grid {
        grid-template-columns: repeat(5, 1fr);
        gap: 1.5rem;
      }
    }

    @media (min-width: 1536px) {
      .movie-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    /* „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥ */
    .pagination-btn {
      padding: 0.875rem 2rem;
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      font-weight: 700;
      transition: all 0.3s ease;
      cursor: pointer;
      backdrop-filter: blur(10px);
    }

    .pagination-btn:hover {
      background: var(--gold);
      color: #000;
      border-color: var(--gold);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }

    .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }

    .pagination-btn:disabled:hover {
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border-color: rgba(212, 175, 55, 0.3);
      box-shadow: none;
    }

    /* „É¢„Éº„ÉÄ„É´ÊîπÂñÑ */
    .modal-tag {
      padding: 0.5rem 1rem;
      background: rgba(212, 175, 55, 0.15);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 20px;
      font-size: 0.875rem;
      color: var(--gold);
      font-weight: 600;
    }

    .modal-link-btn {
      border: 2px solid;
      border-radius: 12px;
      padding: 0.875rem;
      font-weight: 700;
      text-align: center;
      transition: all 0.3s ease;
      display: block;
    }

    .modal-link-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÅÖÂª∂„ÅÆ„Ç´„Çπ„Çø„É†„Éó„É≠„Éë„ÉÜ„Ç£ */
    [style*="--card-index"] {
      animation-delay: calc(var(--card-index) * 0.05s);
    }
  </style>
</head>
<body class="pb-20">

  <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
  <nav class="glass-nav fixed top-0 w-full z-50 p-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center flex-wrap gap-3">
      <div class="flex items-center gap-3 flex-wrap">
        <h1 class="logo-text" id="home-btn">SCREEN DECK</h1>
        <div class="flex gap-2 flex-wrap">
          <button class="btn-filter" id="random-btn">ALL</button>
          <button class="btn-filter" id="unwatched-btn">Êú™Ë¶ñËÅ¥</button>
          <button class="btn-filter" id="short-btn">SHORT</button>
          <button class="btn-filter btn-primary" id="search-btn">üîç Ê§úÁ¥¢</button>
          <button class="btn-filter btn-primary" id="add-btn">+ ADD</button>
        </div>
      </div>
      <div id="page-indicator" class="page-indicator text-xs sm:text-sm" title="„ÇØ„É™„ÉÉ„ÇØ„Åß„Éö„Éº„Ç∏„Ç∏„É£„É≥„Éó">PAGE 1</div>
    </div>
  </nav>

  <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
  <main class="mt-32 px-2 sm:px-4 max-w-7xl mx-auto">
    <!-- „Çø„Ç∞„Éï„Ç£„É´„Çø„Éº -->
    <div id="tag-filter" class="hidden">
      <div class="filter-panel flex items-center justify-between">
        <p>
          <span class="filter-label">„Çø„Ç∞:</span>
          <span id="current-tag" class="filter-value"></span>
        </p>
        <button id="clear-tag" class="filter-clear">‚úï „ÇØ„É™„Ç¢</button>
      </div>
    </div>

    <!-- Ê§úÁ¥¢„Éï„Ç£„É´„Çø„Éº -->
    <div id="search-filter" class="hidden">
      <div class="filter-panel flex items-center justify-between">
        <p>
          <span class="filter-label">Ê§úÁ¥¢:</span>
          <span id="current-search" class="filter-value"></span>
          <span class="filter-label ml-2">(<span id="search-count" style="color: var(--gold);"></span>‰ª∂)</span>
        </p>
        <button id="clear-search" class="filter-clear">‚úï „ÇØ„É™„Ç¢</button>
      </div>
    </div>

    <!-- Êò†Áîª„Ç∞„É™„ÉÉ„Éâ -->
    <div id="movie-grid" class="movie-grid"></div>

    <!-- „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ -->
    <div class="flex justify-center items-center gap-6 mt-16 mb-8">
      <button id="prev-btn" class="pagination-btn">Prev</button>
      <button id="next-btn" class="pagination-btn">Next</button>
    </div>
  </main>

  <!-- Êò†ÁîªË©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
  <div id="modal" class="fixed inset-0 z-[100] hidden bg-black/90 overflow-y-auto">
    <div class="min-h-screen flex items-start justify-center">
      <div class="modal-content relative bg-gradient-to-b from-[#1a1a1a] to-[#0a0a0a] w-full min-h-screen overflow-y-auto">
        <button id="close-modal-btn" class="modal-close fixed top-5 right-5 w-16 h-16 flex items-center justify-center bg-black/80 rounded-full z-50 transition text-3xl font-bold">‚úï</button>
        
        <div class="w-full bg-gradient-to-b from-gray-900 to-black flex items-center justify-center p-2 pt-12">
          <img id="m-poster" class="rounded-xl shadow-2xl w-full max-w-md" alt="Movie Poster">
        </div>
        
        <div class="w-full p-5 pb-24">
          <h2 id="m-title-jp" class="text-white mb-4 text-center title-font text-4xl font-black"></h2>
          
          <div class="flex justify-center mb-5">
            <span id="status-badge" class="px-6 py-2 rounded-full text-xs font-bold uppercase"></span>
          </div>
          
          <p id="m-title-en" class="text-gray-400 italic mb-7 text-center text-xl"></p>
          <div id="m-info" class="text-gray-400 mb-7 pb-7 border-b-2 border-gray-700 text-center font-mono"></div>
          
          <div class="grid grid-cols-2 gap-5 mb-7 bg-gradient-to-r from-gray-900/50 to-gray-800/50 p-6 rounded-2xl">
            <div class="text-center">
              <p class="text-gray-400 font-bold mb-3">IMDb</p>
              <p id="v-imdb" class="text-4xl font-bold" style="color: var(--gold);">--</p>
            </div>
            <div class="text-center">
              <p class="text-gray-400 font-bold mb-3">RT</p>
              <p id="v-rt" class="text-red-400 text-4xl font-bold">--</p>
            </div>
          </div>
          
          <div class="bg-white/5 rounded-2xl p-6 mb-7 border-l-4" style="border-color: var(--gold);">
            <p id="m-comment" class="italic text-gray-100 text-center text-lg"></p>
          </div>
          
          <p id="m-summary" class="text-gray-300 mb-7 text-center leading-relaxed"></p>
          <div id="m-tags" class="flex flex-wrap gap-4 mb-8 justify-center"></div>
          
          <div class="flex flex-col gap-4">
            <button id="toggle-status-btn" class="w-full border-2 hover:bg-green-600 text-white transition rounded-2xl py-4 font-bold" style="border-color: var(--gold);">Ë¶ñËÅ¥Ê∏à„Åø„Å´„Åô„Çã</button>
            <div class="grid grid-cols-3 gap-3">
              <a id="l-imdb" href="#" target="_blank" class="modal-link-btn border-yellow-600 hover:bg-yellow-600 text-white">IMDb</a>
              <a id="l-film" href="#" target="_blank" class="modal-link-btn hover:bg-green-600 text-white" style="border-color: #00be68;">Filmarks</a>
              <a id="l-emby" href="#" target="_blank" class="modal-link-btn border-blue-600 hover:bg-blue-600 text-white">EMBY</a>
            </div>
            <button id="edit-id-btn" class="w-full text-gray-500 hover:text-white underline uppercase mt-3">Edit IMDb ID</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Êò†ÁîªËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
  <div id="add-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-sm bg-gradient-to-b from-gray-900 to-black p-8 rounded-2xl border border-gray-800">
      <h2 class="text-2xl font-black mb-8 uppercase title-font" style="color: var(--gold);">Add To Deck</h2>
      <input id="add-input" type="text" placeholder="IMDb ID (‰æã: tt1234567)" class="w-full p-4 mb-6 bg-white/5 border border-gray-700 rounded-xl text-white focus:outline-none focus:border-yellow-500 transition">
      <div class="flex gap-3">
        <button id="cancel-add-btn" class="flex-1 py-3 border border-gray-700 rounded-xl hover:bg-gray-800 transition font-bold">Cancel</button>
        <button id="reg-btn" class="flex-1 py-3 rounded-xl font-bold btn-primary">Register</button>
      </div>
      <p id="reg-status" class="mt-4 text-sm hidden"></p>
    </div>
  </div>

  <!-- Ê§úÁ¥¢„É¢„Éº„ÉÄ„É´ -->
  <div id="search-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-md bg-gradient-to-b from-gray-900 to-black p-8 rounded-2xl border border-gray-800">
      <h2 class="text-2xl font-black mb-8 uppercase title-font" style="color: var(--gold);">üî¢ Êò†Áîª„ÇíÊ§úÁ¥¢</h2>
      <input id="search-input" type="text" placeholder="„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ..." class="w-full p-4 mb-6 bg-white/5 border border-gray-700 rounded-xl text-white focus:outline-none focus:border-yellow-500 transition">
      <div class="flex gap-3">
        <button id="cancel-search-btn" class="flex-1 py-3 border border-gray-700 rounded-xl hover:bg-gray-800 transition font-bold">„Ç≠„É£„É≥„Çª„É´</button>
        <button id="search-submit-btn" class="flex-1 py-3 rounded-xl font-bold btn-primary">Ê§úÁ¥¢</button>
      </div>
    </div>
  </div>

  <!-- „Éö„Éº„Ç∏„Ç∏„É£„É≥„Éó„É¢„Éº„ÉÄ„É´ -->
  <div id="jump-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-sm bg-gradient-to-b from-gray-900 to-black p-8 rounded-2xl border border-gray-800">
      <h2 class="text-2xl font-black mb-6 uppercase title-font" style="color: var(--gold);">üî¢ „Éö„Éº„Ç∏„Ç∏„É£„É≥„Éó</h2>
      <button id="close-jump-btn" class="modal-close absolute top-4 right-4 w-10 h-10 flex items-center justify-center bg-gray-800 hover:bg-gray-700 rounded-full transition text-xl">‚úï</button>
      <p class="text-gray-400 mb-4">„Éö„Éº„Ç∏Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
      <input id="jump-page-input" type="number" min="1" class="w-full p-4 mb-4 bg-white/5 border border-gray-700 rounded-xl text-white text-center text-2xl font-bold focus:outline-none focus:border-yellow-500 transition">
      <p class="text-sm text-gray-500 mb-6">Á∑è„Éö„Éº„Ç∏Êï∞: <span id="total-pages-display" class="font-bold" style="color: var(--gold);">-</span></p>
      <button id="jump-execute-btn" class="w-full py-3 rounded-xl font-bold btn-primary">„Ç∏„É£„É≥„Éó</button>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwGGgzd6AV99oNuMxdSGwfFt6X4bMy1f3nPFyFwKOD3R9z50gg-OiP0dRjVl6XwQdtN/exec';
    const ITEMS_PER_PAGE = 20;

    let currPage = 1;
    let totalPages = 1;
    let currIdx = -1;
    let currentTag = null;
    let currentSearch = null;

    // ===== „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ =====
    function showLoading() {
      const grid = document.getElementById('movie-grid');
      let html = '';
      for (let i = 0; i < ITEMS_PER_PAGE; i++) {
        html += `
          <div class="skeleton-card">
            <div class="skeleton-poster"></div>
            <div class="skeleton-title"></div>
            <div class="skeleton-meta"></div>
          </div>
        `;
      }
      grid.innerHTML = html;
    }

    // ===== APIÂëº„Å≥Âá∫„Åó =====
    async function callAPI(action, params = {}) {
      const url = new URL(API_URL);
      url.searchParams.append('action', action);
      for (const [k, v] of Object.entries(params)) {
        url.searchParams.append(k, v);
      }
      const res = await fetch(url);
      if (!res.ok) throw new Error('Network error');
      return res.json();
    }

    // ===== „Éö„Éº„Ç∏Ë™≠„ÅøËæº„Åø =====
    async function loadPage(page) {
      console.log('[Debug] loadPage called with page:', page);
      currPage = page;
      
      showLoading();
      
      try {
        const data = await callAPI('getMoviesPaginated', { page });
        
        totalPages = data.totalPages;
        document.getElementById('page-indicator').innerText = `PAGE ${currPage}`;
        
        const grid = document.getElementById('movie-grid');
        let html = '';
        
        data.movies.forEach((m, index) => {
          const watchedClass = m.watched ? 'watched' : '';
          const watchedBadge = m.watched ? '<div class="watched-badge">‚úì</div>' : '';
          
          html += `
            <div class="movie-card ${watchedClass}" data-row="${m.rowIndex}" style="--card-index: ${index};">
              <div class="movie-card-wrapper">
                ${watchedBadge}
                <img src="${m.poster}" alt="${m.titleJP}">
                <div class="movie-overlay">
                  <div class="text-xs text-gray-400">Click for details</div>
                </div>
              </div>
              <h3 class="movie-title truncate uppercase">${m.titleJP}</h3>
              <p class="movie-year">${m.year}</p>
            </div>
          `;
        });
        
        grid.innerHTML = html;
        
        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });
        
        // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆÁä∂ÊÖã
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        prevBtn.disabled = (currPage <= 1);
        nextBtn.disabled = (currPage >= totalPages);
        
      } catch(error) {
        console.error('[Error]', error);
        document.getElementById('movie-grid').innerHTML = '<p class="col-span-full text-center py-20 text-red-500">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</p>';
      }
    }

    // ===== Ë©≥Á¥∞Ë°®Á§∫ =====
    async function showDetail(rowIndex) {
      currIdx = rowIndex;
      document.getElementById('modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      try {
        const data = await callAPI('getMovieByRow', { rowIndex });
        const m = data.movie;
        
        document.getElementById('m-poster').src = m.poster;
        document.getElementById('m-title-jp').innerText = m.titleJP;
        document.getElementById('m-title-en').innerText = m.titleEN || '';
        document.getElementById('m-info').innerText = `${m.year} | ${m.runtime} | ${m.genre}`;
        document.getElementById('m-summary').innerText = m.summary || '';
        document.getElementById('m-comment').innerText = m.comment || '';
        document.getElementById('v-imdb').innerText = m.imdb || '--';
        document.getElementById('v-rt').innerText = m.rt ? m.rt + '%' : '--';
        
        const statusBadge = document.getElementById('status-badge');
        if (m.watched) {
          statusBadge.className = 'px-6 py-2 rounded-full text-xs font-bold uppercase status-watched';
          statusBadge.innerText = 'WATCHED';
          document.getElementById('toggle-status-btn').innerText = 'Êú™Ë¶ñËÅ¥„Å´Êàª„Åô';
        } else {
          statusBadge.className = 'px-6 py-2 rounded-full text-xs font-bold uppercase status-unwatched';
          statusBadge.innerText = 'UNWATCHED';
          document.getElementById('toggle-status-btn').innerText = 'Ë¶ñËÅ¥Ê∏à„Åø„Å´„Åô„Çã';
        }
        
        const tagsDiv = document.getElementById('m-tags');
        if (m.tags && m.tags.length > 0) {
          tagsDiv.innerHTML = m.tags.map(tag => 
            `<span class="modal-tag cursor-pointer" onclick="filterByTag('${tag}')">${tag}</span>`
          ).join('');
        } else {
          tagsDiv.innerHTML = '';
        }
        
        document.getElementById('l-imdb').href = m.imdbID ? `https://www.imdb.com/title/${m.imdbID}/` : '#';
        document.getElementById('l-film').href = m.imdbID ? `https://filmarks.com/list/search?q=${m.imdbID}` : '#';
        document.getElementById('l-emby').href = m.imdbID ? `https://app.emby.media/web/index.html#!/search.html?query=${m.imdbID}&context=tvshows` : '#';
        
      } catch(error) {
        alert('Error: ' + error.message);
      }
    }

    // ===== Ë¶ñËÅ¥„Çπ„ÉÜ„Éº„Çø„ÇπÂàá„ÇäÊõø„Åà =====
    async function toggleStatus() {
      if (currIdx < 0) return;
      
      try {
        const result = await callAPI('toggleWatched', { rowIndex: currIdx });
        
        if (result.success) {
          showDetail(currIdx);
          
          if (currentTag) {
            filterByTag(currentTag);
          } else if (currentSearch) {
            searchMovies(currentSearch);
          } else {
            loadPage(currPage);
          }
        } else {
          alert(result.error || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        }
      } catch(error) {
        alert('Error: ' + error.message);
      }
    }

    // ===== „É©„É≥„ÉÄ„É†ÈÅ∏Êäû =====
    async function pickRandom(mode) {
      showLoading();
      
      try {
        const data = await callAPI('pickRandom', { mode });
        
        if (data.movie) {
          showDetail(data.movie.rowIndex);
        } else {
          alert('Ë©≤ÂΩì„Åô„ÇãÊò†Áîª„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
          loadPage(currPage);
        }
      } catch(error) {
        alert('Error: ' + error.message);
        loadPage(currPage);
      }
    }

    // ===== Êò†ÁîªËøΩÂä† =====
    async function submitAdd() {
      const imdbID = document.getElementById('add-input').value.trim();
      const statusEl = document.getElementById('reg-status');
      
      if (!imdbID) {
        alert('IMDb ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      
      statusEl.innerText = 'Processing...';
      statusEl.className = 'mt-4 text-sm text-yellow-500';
      statusEl.classList.remove('hidden');
      
      try {
        const result = await callAPI('addMovie', { imdbID });
        
        if (result.success) {
          statusEl.innerText = result.message;
          statusEl.className = 'mt-4 text-sm text-green-500';
          
          setTimeout(() => {
            closeAdd();
            loadPage(currPage);
          }, 1500);
        } else {
          statusEl.innerText = result.error;
          statusEl.className = 'mt-4 text-sm text-red-500';
        }
      } catch(error) {
        statusEl.innerText = 'Error: ' + error.message;
        statusEl.className = 'mt-4 text-sm text-red-500';
      }
    }

    // ===== Ê§úÁ¥¢ =====
    async function searchMovies(keyword) {
      currentSearch = keyword;
      currentTag = null;
      
      showLoading();
      
      document.getElementById('search-filter').classList.remove('hidden');
      document.getElementById('tag-filter').classList.add('hidden');
      document.getElementById('current-search').innerText = keyword;
      
      try {
        const data = await callAPI('searchMovies', { keyword });
        
        document.getElementById('search-count').innerText = data.movies.length;
        
        if (data.movies.length === 0) {
          document.getElementById('movie-grid').innerHTML = '<p class="col-span-full text-center py-20 text-gray-500">Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>';
          return;
        }
        
        const grid = document.getElementById('movie-grid');
        let html = '';
        
        data.movies.forEach((m, index) => {
          const watchedClass = m.watched ? 'watched' : '';
          const watchedBadge = m.watched ? '<div class="watched-badge">‚úì</div>' : '';
          
          html += `
            <div class="movie-card ${watchedClass}" data-row="${m.rowIndex}" style="--card-index: ${index};">
              <div class="movie-card-wrapper">
                ${watchedBadge}
                <img src="${m.poster}" alt="${m.titleJP}">
              </div>
              <h3 class="movie-title truncate uppercase">${m.titleJP}</h3>
              <p class="movie-year">${m.year}</p>
            </div>
          `;
        });
        
        grid.innerHTML = html;
        
        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });
        
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        
      } catch(error) {
        document.getElementById('movie-grid').innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    // ===== „Çø„Ç∞„Éï„Ç£„É´„Çø„Éº =====
    async function filterByTag(tag) {
      currentTag = tag;
      currentSearch = null;
      
      closeModal();
      showLoading();
      
      document.getElementById('tag-filter').classList.remove('hidden');
      document.getElementById('search-filter').classList.add('hidden');
      document.getElementById('current-tag').innerText = '#' + tag;
      
      try {
        const data = await callAPI('getMoviesByTag', { tag });
        
        if (data.movies.length === 0) {
          document.getElementById('movie-grid').innerHTML = '<p class="col-span-full text-center py-20 text-gray-500">„Åì„ÅÆ„Çø„Ç∞„ÅÆÊò†Áîª„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
          return;
        }
        
        const grid = document.getElementById('movie-grid');
        let html = '';
        
        data.movies.forEach((m, index) => {
          const watchedClass = m.watched ? 'watched' : '';
          const watchedBadge = m.watched ? '<div class="watched-badge">‚úì</div>' : '';
          
          html += `
            <div class="movie-card ${watchedClass}" data-row="${m.rowIndex}" style="--card-index: ${index};">
              <div class="movie-card-wrapper">
                ${watchedBadge}
                <img src="${m.poster}" alt="${m.titleJP}">
              </div>
              <h3 class="movie-title truncate uppercase">${m.titleJP}</h3>
              <p class="movie-year">${m.year}</p>
            </div>
          `;
        });
        
        grid.innerHTML = html;
        
        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });
        
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        
      } catch(error) {
        document.getElementById('movie-grid').innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    // ===== UIÂà∂Âæ° =====
    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function openAdd() {
      document.getElementById('add-modal').classList.remove('hidden');
      document.getElementById('add-input').value = '';
      document.getElementById('add-input').focus();
    }

    function closeAdd() {
      document.getElementById('add-modal').classList.add('hidden');
      document.getElementById('reg-status').classList.add('hidden');
    }

    function openSearch() {
      document.getElementById('search-modal').classList.remove('hidden');
      document.getElementById('search-input').value = '';
      document.getElementById('search-input').focus();
    }

    function closeSearch() {
      document.getElementById('search-modal').classList.add('hidden');
    }

    function submitSearch() {
      const keyword = document.getElementById('search-input').value.trim();
      if (!keyword) {
        alert('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      closeSearch();
      searchMovies(keyword);
    }

    function clearTagFilter() {
      currentTag = null;
      currentSearch = null;
      document.getElementById('tag-filter').classList.add('hidden');
      document.getElementById('search-filter').classList.add('hidden');
      document.getElementById('prev-btn').style.display = '';
      document.getElementById('next-btn').style.display = '';
      loadPage(1);
    }

    async function editId() {
      const id = prompt('NEW IMDb ID (tt...):');
      if (id && id.trim()) {
        try {
          const result = await callAPI('updateMovieByImdbId', { rowIndex: currIdx, newId: id.trim() });
          alert(result.success ? result.message : result.error);
          if (result.success) showDetail(currIdx);
        } catch(error) {
          alert('Error: ' + error.message);
        }
      }
    }

    // ===== „Éö„Éº„Ç∏„Ç∏„É£„É≥„ÉóÊ©üËÉΩ =====
    function openJumpModal() {
      console.log('[Jump] Opening jump modal');
      document.getElementById('jump-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      document.getElementById('total-pages-display').textContent = totalPages;
      
      setTimeout(() => {
        document.getElementById('jump-page-input').focus();
      }, 100);
    }
    
    function closeJumpModal() {
      document.getElementById('jump-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
      document.getElementById('jump-page-input').value = '';
    }
    
    function executeJump() {
      const input = document.getElementById('jump-page-input');
      const pageNum = parseInt(input.value);
      
      if (isNaN(pageNum) || pageNum < 1 || pageNum > totalPages) {
        alert(`1„Åã„Çâ${totalPages}„ÅÆÈñì„ÅÆ„Éö„Éº„Ç∏Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`);
        return;
      }
      
      console.log('[Jump] Jumping to page:', pageNum);
      
      closeJumpModal();
      loadPage(pageNum);
    }

    // ===== ÂàùÊúüÂåñ =====
    window.onload = () => {
      console.log('[Debug] window.onload started');
      loadPage(1);
      
      // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
      document.getElementById('home-btn').onclick = clearTagFilter;
      document.getElementById('random-btn').onclick = () => pickRandom('all');
      document.getElementById('unwatched-btn').onclick = () => pickRandom('unwatched');
      document.getElementById('short-btn').onclick = () => pickRandom('short');
      document.getElementById('page-indicator').onclick = openJumpModal;
      document.getElementById('search-btn').onclick = openSearch;
      document.getElementById('add-btn').onclick = openAdd;
      document.getElementById('prev-btn').onclick = () => loadPage(currPage - 1);
      document.getElementById('next-btn').onclick = () => loadPage(currPage + 1);
      document.getElementById('close-modal-btn').onclick = closeModal;
      document.getElementById('cancel-add-btn').onclick = closeAdd;
      document.getElementById('reg-btn').onclick = submitAdd;
      document.getElementById('edit-id-btn').onclick = editId;
      document.getElementById('toggle-status-btn').onclick = toggleStatus;
      document.getElementById('clear-tag').onclick = clearTagFilter;
      document.getElementById('cancel-search-btn').onclick = closeSearch;
      document.getElementById('search-submit-btn').onclick = submitSearch;
      document.getElementById('clear-search').onclick = clearTagFilter;
      
      document.getElementById('search-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') submitSearch();
      });

      // „Éö„Éº„Ç∏„Ç∏„É£„É≥„Éó„Ç≥„É≥„Éà„É≠„Éº„É´
      document.getElementById('close-jump-btn').onclick = closeJumpModal;
      document.getElementById('jump-execute-btn').onclick = executeJump;
      document.getElementById('jump-page-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') executeJump();
      });
      
      console.log('[Debug] All event listeners attached successfully');
    };

    // ===== Service WorkerÁôªÈå≤ =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('[PWA] Service Worker registered:', reg.scope))
          .catch(err => console.log('[PWA] Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
