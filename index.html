<!DOCTYPE html>
<html lang="ja" data-theme="original">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Screen Deck">
  <title>Screen Deck</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=1wXXnWU1jUCjajzlGiuNhP1kQxm53_9Lc">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&family=Urbanist:wght@400;500;600;700;800&family=SF+Pro+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ==================== CSS Variables for Theming ==================== */
    
    /* Original Theme (Default) */
    :root[data-theme="original"] {
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --bg-card: #1a1a1a;
      --bg-nav: rgba(0, 0, 0, 0.95);
      
      --text-primary: #ffffff;
      --text-secondary: #C0C0C0;
      --text-tertiary: #888888;
      
      --accent-primary: #ffffff;
      --accent-secondary: #00be68;
      --accent-danger: #ff3b30;
      
      --border-color: #222222;
      --border-secondary: #333333;
      
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.6);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.8);
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 9999px;
      
      --font-display: 'Outfit', sans-serif;
      --font-body: 'Inter', sans-serif;
      --font-mono: 'Monaco', monospace;
    }
    
    /* Apple TV+ Theme */
    :root[data-theme="appletv"] {
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --bg-card: rgba(255, 255, 255, 0.05);
      --bg-nav: rgba(0, 0, 0, 0.8);
      
      --text-primary: #F5F5F7;
      --text-secondary: #86868B;
      --text-tertiary: #6E6E73;
      
      --accent-primary: #0071E3;
      --accent-secondary: #FF375F;
      --accent-danger: #FF3B30;
      
      --border-color: rgba(255, 255, 255, 0.08);
      --border-secondary: rgba(255, 255, 255, 0.12);
      
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.6);
      
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 20px;
      --radius-full: 9999px;
      
      --font-display: 'SF Pro Display', -apple-system, 'Outfit', sans-serif;
      --font-body: 'SF Pro Display', -apple-system, 'Inter', sans-serif;
      --font-mono: 'SF Mono', 'Monaco', monospace;
    }
    
    /* Material Design 3 Theme */
    :root[data-theme="material"] {
      --bg-primary: #1C1B1F;
      --bg-secondary: #141318;
      --bg-card: #2B2930;
      --bg-nav: rgba(28, 27, 31, 0.95);
      
      --text-primary: #E6E1E5;
      --text-secondary: #CCC2DC;
      --text-tertiary: #938F99;
      
      --accent-primary: #D0BCFF;
      --accent-secondary: #7D5260;
      --accent-danger: #F2B8B5;
      
      --border-color: #938F99;
      --border-secondary: #49454F;
      
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
      --shadow-md: 0 1px 2px rgba(0, 0, 0, 0.3), 0 2px 6px 2px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 4px 8px 3px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.3);
      
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 28px;
      --radius-full: 9999px;
      
      --font-display: 'Urbanist', sans-serif;
      --font-body: 'Inter', sans-serif;
      --font-mono: 'Monaco', monospace;
    }
    
    /* Neon Night Theme - ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯é¢¨ */
    :root[data-theme="neon"] {
      --bg-primary: #0a0e27;
      --bg-secondary: #0f1535;
      --bg-card: #1a1f3a;
      --bg-nav: rgba(10, 14, 39, 0.95);
      
      --text-primary: #e0f7ff;
      --text-secondary: #8fb9d9;
      --text-tertiary: #5a7fa0;
      
      --accent-primary: #00ffff;
      --accent-secondary: #ff006e;
      --accent-danger: #ff3a5e;
      
      --border-color: #00ffff;
      --border-secondary: #ff006e;
      
      --shadow-sm: 0 0 10px rgba(0, 255, 255, 0.3);
      --shadow-md: 0 0 20px rgba(0, 255, 255, 0.4);
      --shadow-lg: 0 0 40px rgba(0, 255, 255, 0.5);
      
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 16px;
      --radius-full: 9999px;
      
      --font-display: 'Urbanist', sans-serif;
      --font-body: 'Inter', sans-serif;
      --font-mono: 'Monaco', monospace;
    }
    
    /* Retro Cinema Theme - ãƒ“ãƒ³ãƒ†ãƒ¼ã‚¸æ˜ ç”»é¤¨é¢¨ */
    :root[data-theme="retro"] {
      --bg-primary: #1a0f0f;
      --bg-secondary: #2d1414;
      --bg-card: #3d1f1f;
      --bg-nav: rgba(26, 15, 15, 0.95);
      
      --text-primary: #f4e4c1;
      --text-secondary: #d4c4a1;
      --text-tertiary: #b4a481;
      
      --accent-primary: #d4af37;
      --accent-secondary: #8b0000;
      --accent-danger: #ff4444;
      
      --border-color: #d4af37;
      --border-secondary: #8b0000;
      
      --shadow-sm: 0 2px 8px rgba(212, 175, 55, 0.2);
      --shadow-md: 0 4px 16px rgba(212, 175, 55, 0.3);
      --shadow-lg: 0 8px 32px rgba(212, 175, 55, 0.4);
      
      --radius-sm: 2px;
      --radius-md: 4px;
      --radius-lg: 8px;
      --radius-full: 9999px;
      
      --font-display: 'Urbanist', sans-serif;
      --font-body: 'Inter', sans-serif;
      --font-mono: 'Monaco', monospace;
    }
    
    /* Light Mode Theme - æ˜ã‚‹ã„ãƒ†ãƒ¼ãƒ */
    :root[data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-card: #fafafa;
      --bg-nav: rgba(255, 255, 255, 0.95);
      
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --text-tertiary: #999999;
      
      --accent-primary: #2563eb;
      --accent-secondary: #10b981;
      --accent-danger: #ef4444;
      
      --border-color: #e5e5e5;
      --border-secondary: #d4d4d4;
      
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.2);
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-full: 9999px;
      
      --font-display: 'Outfit', sans-serif;
      --font-body: 'Inter', sans-serif;
      --font-mono: 'Monaco', monospace;
    }
    
    /* ==================== Base Styles ==================== */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-body);
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    h1, h2, h3, .title-font {
      font-family: var(--font-display);
      letter-spacing: -0.02em;
    }
    
    .display-font {
      font-family: var(--font-display);
      letter-spacing: -0.01em;
    }
    
    .mono-font {
      font-family: var(--font-mono);
      letter-spacing: 0.02em;
    }
    
    /* ==================== Theme Dropdown Menu ==================== */
    
    #theme-menu-container {
      position: relative;
    }
    
    .theme-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-card);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-lg);
      min-width: 200px;
      z-index: 1000;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .theme-dropdown.hidden {
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
    }
    
    .theme-dropdown:not(.hidden) {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .theme-option {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .theme-option:hover {
      background: var(--bg-secondary);
    }
    
    .theme-option:not(:last-child) {
      border-bottom: 1px solid var(--border-color);
    }
    
    .theme-icon {
      font-size: 20px;
      width: 24px;
      text-align: center;
    }
    
    .theme-name {
      flex: 1;
      text-align: left;
    }
    
    .theme-check {
      color: var(--accent-secondary);
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .theme-option.active .theme-check {
      opacity: 1;
    }
    
    .theme-option.active {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }
    
    .theme-option.active .theme-check {
      color: var(--bg-primary);
    }
    
    [data-theme="appletv"] .theme-dropdown {
      backdrop-filter: blur(30px);
      background: rgba(255, 255, 255, 0.08);
    }
    
    [data-theme="material"] .theme-dropdown {
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }
    
    @media (max-width: 768px) {
      .theme-dropdown {
        right: auto;
        left: 0;
        min-width: 180px;
      }
    }
    
    /* ==================== Movie Cards ==================== */
    
    .movie-card { 
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      cursor: pointer;
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    
    .movie-card:active { 
      transform: scale(0.95); 
    }
    
    @media (min-width: 768px) {
      .movie-card:hover { 
        transform: translateY(-8px);
        box-shadow: var(--shadow-lg);
      }
    }
    
    [data-theme="appletv"] .movie-card {
      background: var(--bg-card);
      backdrop-filter: blur(20px);
    }
    
    [data-theme="material"] .movie-card {
      box-shadow: var(--shadow-sm);
    }
    
    [data-theme="material"] .movie-card:hover {
      box-shadow: var(--shadow-md);
    }
    
    .movie-card.watched::after {
      content: 'âœ“';
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--accent-secondary);
      color: var(--bg-primary);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      box-shadow: var(--shadow-md);
    }
    
    @media (min-width: 1024px) {
      .movie-card.watched::after {
        width: 28px;
        height: 28px;
        font-size: 16px;
        top: 6px;
        right: 6px;
      }
    }
    
    .movie-card img {
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
    }
    
    /* ==================== Navigation ==================== */
    
    .glass-nav { 
      background: var(--bg-nav);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }
    
    [data-theme="appletv"] .glass-nav {
      backdrop-filter: blur(30px);
    }
    
    [data-theme="material"] .glass-nav {
      box-shadow: var(--shadow-sm);
    }
    
    /* ==================== Buttons ==================== */
    
    button, .btn {
      font-family: var(--font-body);
      transition: all 0.2s ease;
    }
    
    .border {
      border-color: var(--border-secondary) !important;
    }
    
    .bg-black {
      background-color: var(--bg-secondary) !important;
    }
    
    .bg-white {
      background-color: var(--accent-primary) !important;
      color: var(--bg-primary) !important;
    }
    
    .text-black {
      color: var(--bg-primary) !important;
    }
    
    .hover\:bg-white:hover {
      background-color: var(--accent-primary) !important;
      color: var(--bg-primary) !important;
    }
    
    [data-theme="material"] button {
      border-radius: var(--radius-lg);
    }
    
    [data-theme="appletv"] button {
      backdrop-filter: blur(20px);
    }
    
    /* ==================== Status Badges ==================== */
    
    .status-unwatched {
      background: rgba(255, 59, 48, 0.2);
      color: var(--accent-danger);
      border: 1px solid var(--accent-danger);
    }
    
    .status-watched {
      background: rgba(0, 190, 104, 0.2);
      color: var(--accent-secondary);
      border: 1px solid var(--accent-secondary);
    }
    
    /* ==================== Modal Styles ==================== */
    
    #modal {
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
    }
    
    [data-theme="appletv"] #modal {
      backdrop-filter: blur(30px);
    }
    
    #modal .bg-gradient-to-b {
      background: linear-gradient(to bottom, var(--bg-card), var(--bg-secondary));
    }
    
    /* ==================== Misc ==================== */
    
    .silver-text { 
      color: var(--text-secondary);
    }
    
    .text-gray-400,
    .text-gray-500 {
      color: var(--text-tertiary) !important;
    }
    
    .bg-gray-900 {
      background: var(--bg-card) !important;
    }
    
    .border-gray-700,
    .border-gray-800 {
      border-color: var(--border-secondary) !important;
    }
    
    /* ==================== Theme-specific Enhancements ==================== */
    
    /* Apple TV+ Glass Effect */
    [data-theme="appletv"] .movie-card,
    [data-theme="appletv"] #add-modal > div,
    [data-theme="appletv"] #search-modal > div,
    [data-theme="appletv"] #jump-modal > div {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(30px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    [data-theme="appletv"] input {
      background: rgba(255, 255, 255, 0.08) !important;
      border-color: rgba(255, 255, 255, 0.12) !important;
      backdrop-filter: blur(20px);
    }
    
    /* Material Design Elevation */
    [data-theme="material"] .glass-nav {
      border-radius: 0;
    }
    
    [data-theme="material"] #add-modal > div,
    [data-theme="material"] #search-modal > div,
    [data-theme="material"] #jump-modal > div {
      border-radius: var(--radius-lg);
    }
    
    [data-theme="material"] .movie-card {
      border-radius: var(--radius-md);
    }
    
    /* ==================== Neon Night Theme Enhancements ==================== */
    
    [data-theme="neon"] body {
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
    }
    
    [data-theme="neon"] .movie-card {
      border: 1px solid var(--accent-primary);
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }
    
    [data-theme="neon"] .movie-card:hover {
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.6), 0 0 60px rgba(255, 0, 110, 0.3);
      border-color: var(--accent-secondary);
    }
    
    [data-theme="neon"] button {
      text-shadow: 0 0 5px currentColor;
    }
    
    [data-theme="neon"] .glass-nav {
      border-bottom: 2px solid var(--accent-primary);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }
    
    [data-theme="neon"] #modal {
      background: rgba(10, 14, 39, 0.95);
      backdrop-filter: blur(20px);
    }
    
    [data-theme="neon"] .status-watched {
      background: rgba(0, 255, 255, 0.2);
      color: var(--accent-primary);
      border: 1px solid var(--accent-primary);
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
    
    [data-theme="neon"] .status-unwatched {
      background: rgba(255, 0, 110, 0.2);
      color: var(--accent-secondary);
      border: 1px solid var(--accent-secondary);
      box-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
    }
    
    /* ==================== Retro Cinema Theme Enhancements ==================== */
    
    [data-theme="retro"] body {
      background: linear-gradient(180deg, #1a0f0f 0%, #2d1414 100%);
    }
    
    [data-theme="retro"] .glass-nav {
      border-bottom: 3px solid var(--accent-primary);
      background: linear-gradient(180deg, rgba(26, 15, 15, 0.98) 0%, rgba(45, 20, 20, 0.95) 100%);
    }
    
    [data-theme="retro"] .movie-card {
      border: 2px solid var(--accent-primary);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }
    
    [data-theme="retro"] .movie-card:hover {
      box-shadow: 0 8px 24px rgba(212, 175, 55, 0.5);
      transform: translateY(-8px) scale(1.02);
    }
    
    [data-theme="retro"] h1, [data-theme="retro"] h2, [data-theme="retro"] h3 {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    [data-theme="retro"] button {
      font-weight: 700;
    }
    
    [data-theme="retro"] #modal {
      background: linear-gradient(180deg, rgba(26, 15, 15, 0.95) 0%, rgba(45, 20, 20, 0.98) 100%);
    }
    
    [data-theme="retro"] .status-watched {
      background: rgba(212, 175, 55, 0.2);
      color: var(--accent-primary);
      border: 2px solid var(--accent-primary);
    }
    
    [data-theme="retro"] .status-unwatched {
      background: rgba(139, 0, 0, 0.2);
      color: var(--accent-secondary);
      border: 2px solid var(--accent-secondary);
    }
    
    /* ==================== Light Mode Theme Enhancements ==================== */
    
    [data-theme="light"] body {
      background: #ffffff;
    }
    
    [data-theme="light"] .glass-nav {
      background: rgba(255, 255, 255, 0.98);
      border-bottom: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    [data-theme="light"] .movie-card {
      background: white;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    [data-theme="light"] .movie-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    [data-theme="light"] #modal {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
    }
    
    [data-theme="light"] .status-watched {
      background: rgba(16, 185, 129, 0.1);
      color: var(--accent-secondary);
      border: 1px solid var(--accent-secondary);
    }
    
    [data-theme="light"] .status-unwatched {
      background: rgba(239, 68, 68, 0.1);
      color: var(--accent-danger);
      border: 1px solid var(--accent-danger);
    }
    
    [data-theme="light"] input {
      background: white !important;
      border-color: var(--border-color) !important;
      color: var(--text-primary) !important;
    }
    
    [data-theme="light"] .theme-dropdown {
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    [data-theme="light"] #add-modal > div,
    [data-theme="light"] #search-modal > div,
    [data-theme="light"] #jump-modal > div {
      background: white;
      color: var(--text-primary);
    }
    
    /* ==================== Animations ==================== */
    
    @keyframes theme-switch {
      0% { opacity: 0; transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .theme-switching {
      animation: theme-switch 0.3s ease;
    }
    
    /* Loading Animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }
    
    /* Pagination Info Animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .pagination-info {
      animation: fadeInUp 0.3s ease;
    }
    
    /* Smooth transitions for buttons */
    button {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    button:disabled {
      pointer-events: none;
    }
    
    /* New Releases Modal Styles */
    .days-filter-btn.active {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }
    
    .service-section {
      margin-bottom: 2rem;
    }
    
    .release-card {
      position: relative;
    }
    
    .release-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }
    
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="pb-20">

  <nav class="glass-nav fixed top-0 w-full z-50 p-4 flex justify-between items-center flex-wrap gap-3">
    <div class="flex items-center gap-3 flex-wrap">
      <h1 class="font-black cursor-pointer title-font" style="font-size: 24px;" id="home-btn">SCREEN DECK</h1>
      <div class="flex gap-2 flex-wrap">
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="random-btn">ALL</button>
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="unwatched-btn">æœªè¦–è´</button>
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="short-btn">SHORT</button>
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="new-releases-btn">ğŸ†• æ–°è¦é…ä¿¡</button>
        <button class="border border-gray-700 rounded-full bg-white text-black hover:bg-gray-200 transition" style="font-size: 14px; padding: 8px 16px; font-weight: 700;" id="search-btn">ğŸ” æ¤œç´¢</button>
        <button class="border border-gray-700 rounded-full bg-white text-black hover:bg-gray-200 transition" style="font-size: 14px; padding: 8px 16px; font-weight: 700;" id="add-btn">+ ADD</button>
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="export-btn">ğŸ“¥ EXPORT</button>
        
        <!-- Theme Menu Button -->
        <div class="relative" id="theme-menu-container">
          <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="theme-menu-btn">ğŸ¨ THEME</button>
          
          <!-- Theme Dropdown Menu -->
          <div id="theme-dropdown" class="theme-dropdown hidden">
            <button class="theme-option" data-theme="original" onclick="selectTheme('original')">
              <span class="theme-icon">ğŸŒ‘</span>
              <span class="theme-name">ã‚ªãƒªã‚¸ãƒŠãƒ«</span>
              <span class="theme-check" id="check-original">âœ“</span>
            </button>
            <button class="theme-option" data-theme="appletv" onclick="selectTheme('appletv')">
              <span class="theme-icon">ğŸ</span>
              <span class="theme-name">Apple TV+</span>
              <span class="theme-check" id="check-appletv">âœ“</span>
            </button>
            <button class="theme-option" data-theme="material" onclick="selectTheme('material')">
              <span class="theme-icon">ğŸ¨</span>
              <span class="theme-name">Material Design</span>
              <span class="theme-check" id="check-material">âœ“</span>
            </button>
            <button class="theme-option" data-theme="neon" onclick="selectTheme('neon')">
              <span class="theme-icon">âš¡</span>
              <span class="theme-name">ãƒã‚ªãƒ³ãƒŠã‚¤ãƒˆ</span>
              <span class="theme-check" id="check-neon">âœ“</span>
            </button>
            <button class="theme-option" data-theme="retro" onclick="selectTheme('retro')">
              <span class="theme-icon">ğŸ¬</span>
              <span class="theme-name">ãƒ¬ãƒˆãƒ­ã‚·ãƒãƒ</span>
              <span class="theme-check" id="check-retro">âœ“</span>
            </button>
            <button class="theme-option" data-theme="light" onclick="selectTheme('light')">
              <span class="theme-icon">â˜€ï¸</span>
              <span class="theme-name">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</span>
              <span class="theme-check" id="check-light">âœ“</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <div id="page-indicator" class="mono-font silver-text cursor-pointer hover:text-white transition text-xs sm:text-sm" title="ã‚¯ãƒªãƒƒã‚¯ã§ãƒšãƒ¼ã‚¸ã‚¸ãƒ£ãƒ³ãƒ—">PAGE 1</div>
      <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition text-xs px-3 py-1" id="export-btn" title="ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">ğŸ“¥</button>
      <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition text-xs px-3 py-1" id="help-btn" title="ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ">âŒ¨ï¸</button>
    </div>
  </nav>

  <main class="mt-32 px-2 sm:px-4 max-w-7xl mx-auto">
    <div id="tag-filter" class="mb-6 hidden">
      <div class="flex items-center justify-between">
        <p class="silver-text">ã‚¿ã‚°: <span id="current-tag" class="text-white font-bold"></span></p>
        <button id="clear-tag" class="text-gray-500 hover:text-white">âœ• ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <div id="search-filter" class="mb-6 hidden">
      <div class="flex items-center justify-between">
        <p class="silver-text">æ¤œç´¢: <span id="current-search" class="text-white font-bold"></span> (<span id="search-count" class="text-yellow-400"></span>ä»¶)</p>
        <button id="clear-search" class="text-gray-500 hover:text-white">âœ• ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <div id="movie-grid" class="grid grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4 md:gap-6"></div>
    <div class="flex justify-center items-center gap-6 mt-16 mb-8">
      <button id="prev-btn" class="border border-gray-800 hover:bg-white hover:text-black transition font-bold px-8 py-3 rounded-full disabled:opacity-30 disabled:cursor-not-allowed">â† Prev</button>
      <div class="pagination-info text-center">
        <div class="text-white font-bold text-lg" id="current-page-display">1</div>
        <div class="text-gray-500 text-xs mt-1">of <span id="total-pages-display">1</span></div>
      </div>
      <button id="next-btn" class="border border-gray-800 hover:bg-white hover:text-black transition font-bold px-8 py-3 rounded-full disabled:opacity-30 disabled:cursor-not-allowed">Next â†’</button>
    </div>
  </main>

  <div id="modal" class="fixed inset-0 z-[100] hidden bg-black overflow-y-auto">
    <div class="min-h-screen flex items-start justify-center">
      <div class="relative bg-gradient-to-b from-[#1a1a1a] to-[#0a0a0a] w-full min-h-screen overflow-y-auto">
        <button id="close-modal-btn" class="fixed top-5 right-5 w-16 h-16 flex items-center justify-center bg-black/80 hover:bg-white hover:text-black rounded-full z-50 transition text-3xl font-bold">âœ•</button>
        <div class="w-full bg-gradient-to-b from-gray-900 to-black flex items-center justify-center p-2 pt-12">
          <img id="m-poster" class="rounded-xl shadow-2xl w-full max-w-md" alt="Movie Poster">
        </div>
        <div class="w-full p-5 pb-24">
          <h2 id="m-title-jp" class="text-white mb-4 text-center title-font text-4xl font-black"></h2>
          <div class="flex justify-center mb-5">
            <span id="status-badge" class="px-6 py-2 rounded-full text-xs font-bold uppercase"></span>
          </div>
          <p id="m-title-en" class="silver-text italic mb-7 text-center text-xl"></p>
          <div id="m-info" class="mono-font silver-text mb-7 pb-7 border-b-2 border-gray-700 text-center"></div>
          <div class="grid grid-cols-2 gap-5 mb-7 bg-gradient-to-r from-gray-900/50 to-gray-800/50 p-6 rounded-2xl">
            <div class="text-center">
              <p class="text-gray-400 font-bold mb-3">IMDb</p>
              <p id="v-imdb" class="mono-font text-yellow-400 text-4xl font-bold">--</p>
            </div>
            <div class="text-center">
              <p class="text-gray-400 font-bold mb-3">RT</p>
              <p id="v-rt" class="mono-font text-red-400 text-4xl font-bold">--</p>
            </div>
          </div>
          <div class="bg-white/5 rounded-2xl p-6 mb-7 border-l-4 border-white">
            <p id="m-comment" class="italic text-gray-100 text-center text-lg"></p>
          </div>
          <p id="m-summary" class="text-gray-300 mb-7 text-center leading-relaxed"></p>
          <div id="m-tags" class="flex flex-wrap gap-4 mb-8 justify-center"></div>
          
          <div class="flex flex-col gap-4">
            <button id="toggle-status-btn" class="w-full border-2 border-green-600 hover:bg-green-600 text-white transition rounded-2xl py-4 font-bold">è¦–è´æ¸ˆã¿ã«ã™ã‚‹</button>
            <div class="grid grid-cols-3 gap-3">
              <a id="l-imdb" href="#" target="_blank" class="text-center border-2 border-yellow-600 hover:bg-yellow-600 text-white transition rounded-2xl py-3 font-bold text-sm">IMDb</a>
              <a id="l-film" href="#" target="_blank" class="text-center border-2 border-[#00be68] hover:bg-[#00be68] text-white transition rounded-2xl py-3 font-bold text-sm">Filmarks</a>
              <a id="l-emby" href="#" target="_blank" class="text-center border-2 border-blue-600 hover:bg-blue-600 text-white transition rounded-2xl py-3 font-bold text-sm">EMBY</a>
            </div>
            <button id="edit-id-btn" class="w-full text-gray-500 hover:text-white underline uppercase mt-3">Edit IMDb ID</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="add-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-sm">
      <h2 class="text-2xl font-black mb-8 uppercase">Add To Deck</h2>
      
      <!-- æ¤œç´¢æ–¹æ³•é¸æŠãƒœã‚¿ãƒ³ -->
      <div class="flex gap-2 mb-6 justify-center">
        <button id="method-title" class="search-method-btn active border border-gray-600 rounded-full px-6 py-2 font-bold text-sm">æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«</button>
        <button id="method-imdb" class="search-method-btn border border-gray-600 rounded-full px-6 py-2 font-bold text-sm">IMDB ID</button>
      </div>
      
      <input id="add-input" type="text" placeholder="æ˜ ç”»ã®æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" class="w-full p-4 mb-6 rounded-2xl bg-gray-900 border-2 border-gray-700 text-white focus:outline-none focus:border-white">
      <div class="flex gap-4">
        <button id="cancel-add-btn" class="flex-1 border-2 border-gray-600 hover:bg-gray-600 text-white transition rounded-2xl py-3 font-bold">Cancel</button>
        <button id="reg-btn" class="flex-1 border-2 border-white hover:bg-white hover:text-black text-white transition rounded-2xl py-3 font-bold">Register</button>
      </div>
      <div id="reg-status" class="mt-6 p-4 bg-gray-900/70 rounded-2xl border border-gray-700 hidden"></div>
    </div>
  </div>

  <div id="search-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-sm">
      <h2 class="text-2xl font-black mb-8 uppercase">Search Deck</h2>
      <input id="search-input" type="text" placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰" class="w-full p-4 mb-6 rounded-2xl bg-gray-900 border-2 border-gray-700 text-white focus:outline-none focus:border-white">
      <div class="flex gap-4">
        <button id="cancel-search-btn" class="flex-1 border-2 border-gray-600 hover:bg-gray-600 text-white transition rounded-2xl py-3 font-bold">Cancel</button>
        <button id="search-submit-btn" class="flex-1 border-2 border-white hover:bg-white hover:text-black text-white transition rounded-2xl py-3 font-bold">Search</button>
      </div>
    </div>
  </div>

  <div id="jump-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-sm">
      <h2 class="text-2xl font-black mb-4 uppercase">Jump to Page</h2>
      <p class="text-gray-400 mb-8">Total Pages: <span id="total-pages-display" class="text-white font-bold">--</span></p>
      <input id="jump-page-input" type="number" min="1" placeholder="ãƒšãƒ¼ã‚¸ç•ªå·" class="w-full p-4 mb-6 rounded-2xl bg-gray-900 border-2 border-gray-700 text-white focus:outline-none focus:border-white text-center text-xl">
      <div class="flex gap-4">
        <button id="close-jump-btn" class="flex-1 border-2 border-gray-600 hover:bg-gray-600 text-white transition rounded-2xl py-3 font-bold">Cancel</button>
        <button id="jump-execute-btn" class="flex-1 border-2 border-white hover:bg-white hover:text-black text-white transition rounded-2xl py-3 font-bold">GO</button>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="help-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-gray-900 rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-black uppercase">âŒ¨ï¸ Shortcuts</h2>
        <button class="text-gray-400 hover:text-white text-2xl" onclick="closeHelp()">Ã—</button>
      </div>
      <div class="space-y-4 text-left">
        <div class="flex justify-between items-center border-b border-gray-700 pb-3">
          <span class="text-gray-400">æ¬¡ã®ãƒšãƒ¼ã‚¸</span>
          <kbd class="px-3 py-1 bg-gray-800 rounded text-white font-mono">â†’</kbd>
        </div>
        <div class="flex justify-between items-center border-b border-gray-700 pb-3">
          <span class="text-gray-400">å‰ã®ãƒšãƒ¼ã‚¸</span>
          <kbd class="px-3 py-1 bg-gray-800 rounded text-white font-mono">â†</kbd>
        </div>
        <div class="flex justify-between items-center border-b border-gray-700 pb-3">
          <span class="text-gray-400">æ¤œç´¢ã‚’é–‹ã</span>
          <kbd class="px-3 py-1 bg-gray-800 rounded text-white font-mono">/</kbd>
        </div>
        <div class="flex justify-between items-center border-b border-gray-700 pb-3">
          <span class="text-gray-400">ãƒ˜ãƒ«ãƒ—ã‚’é–‹ã</span>
          <kbd class="px-3 py-1 bg-gray-800 rounded text-white font-mono">?</kbd>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-400">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢</span>
          <kbd class="px-3 py-1 bg-gray-800 rounded text-white font-mono">ESC</kbd>
        </div>
      </div>
      <button class="w-full mt-6 border-2 border-white hover:bg-white hover:text-black text-white transition rounded-2xl py-3 font-bold" onclick="closeHelp()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="export-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-gray-900 rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-black uppercase">ğŸ“¥ Export Data</h2>
        <button class="text-gray-400 hover:text-white text-2xl" onclick="closeExport()">Ã—</button>
      </div>
      
      <p class="text-gray-400 text-sm mb-6">æ˜ ç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä»¥ä¸‹ã®å½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã¾ã™</p>
      
      <div class="space-y-3">
        <button class="export-format-btn w-full p-4 bg-gray-800 hover:bg-gray-700 rounded-xl transition text-left" onclick="exportData('csv')">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold text-white text-lg">ğŸ“Š CSV</div>
              <div class="text-gray-400 text-sm">Excel/ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§é–‹ã</div>
            </div>
            <div class="text-2xl">â†’</div>
          </div>
        </button>
        
        <button class="export-format-btn w-full p-4 bg-gray-800 hover:bg-gray-700 rounded-xl transition text-left" onclick="exportData('json')">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold text-white text-lg">ğŸ’¾ JSON</div>
              <div class="text-gray-400 text-sm">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‡¦ç†å¯èƒ½</div>
            </div>
            <div class="text-2xl">â†’</div>
          </div>
        </button>
        
        <button class="export-format-btn w-full p-4 bg-gray-800 hover:bg-gray-700 rounded-xl transition text-left" onclick="exportData('markdown')">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold text-white text-lg">ğŸ“ Markdown</div>
              <div class="text-gray-400 text-sm">èª­ã¿ã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼</div>
            </div>
            <div class="text-2xl">â†’</div>
          </div>
        </button>
      </div>
      
      <div id="export-status" class="mt-4 p-3 bg-gray-800 rounded-xl text-center text-sm hidden"></div>
      
      <button class="w-full mt-6 border-2 border-gray-600 hover:bg-gray-600 text-white transition rounded-2xl py-3 font-bold" onclick="closeExport()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="export-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-gray-900 rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-black uppercase">ğŸ“¥ Export Data</h2>
        <button class="text-gray-400 hover:text-white text-2xl" onclick="closeExport()">Ã—</button>
      </div>
      
      <p class="text-gray-400 text-sm mb-6">æ˜ ç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä»¥ä¸‹ã®å½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã¾ã™</p>
      
      <div class="space-y-3">
        <button class="export-format-btn w-full p-4 bg-gray-800 hover:bg-gray-700 rounded-xl transition text-left" onclick="exportData('csv')">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold text-white text-lg">ğŸ“Š CSV</div>
              <div class="text-gray-400 text-sm">Excel/ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§é–‹ã</div>
            </div>
            <div class="text-2xl">â†’</div>
          </div>
        </button>
        
        <button class="export-format-btn w-full p-4 bg-gray-800 hover:bg-gray-700 rounded-xl transition text-left" onclick="exportData('json')">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold text-white text-lg">ğŸ’¾ JSON</div>
              <div class="text-gray-400 text-sm">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‡¦ç†å¯èƒ½</div>
            </div>
            <div class="text-2xl">â†’</div>
          </div>
        </button>
        
        <button class="export-format-btn w-full p-4 bg-gray-800 hover:bg-gray-700 rounded-xl transition text-left" onclick="exportData('html')">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-bold text-white text-lg">ğŸ“„ HTML</div>
              <div class="text-gray-400 text-sm">å°åˆ·ç”¨ãƒšãƒ¼ã‚¸ã‚’é–‹ã</div>
            </div>
            <div class="text-2xl">â†’</div>
          </div>
        </button>
      </div>
      
      <div id="export-status" class="mt-4 p-3 bg-gray-800 rounded-xl text-center text-sm hidden"></div>
      
      <button class="w-full mt-6 border-2 border-gray-600 hover:bg-gray-600 text-white transition rounded-2xl py-3 font-bold" onclick="closeExport()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- New Releases Modal -->
  <div id="new-releases-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur overflow-y-auto">
    <div class="min-h-screen flex items-start justify-center p-4 py-8">
      <div class="w-full max-w-4xl bg-gray-900 rounded-2xl p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-black uppercase">ğŸ†• æ–°è¦é…ä¿¡</h2>
          <button class="text-gray-400 hover:text-white text-2xl" onclick="closeNewReleases()">Ã—</button>
        </div>
        
        <p class="text-gray-400 text-sm mb-4">éå»7æ—¥é–“ã«é…ä¿¡é–‹å§‹ã•ã‚ŒãŸæ˜ ç”»ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™</p>
        
        <div id="new-releases-status" class="mb-4 p-4 bg-gray-800 rounded-xl text-center"></div>
        
        <div id="new-releases-content" class="space-y-4">
          <!-- å‹•çš„ã«è¿½åŠ  -->
        </div>
        
        <button class="w-full mt-6 border-2 border-gray-600 hover:bg-gray-600 text-white transition rounded-2xl py-3 font-bold" onclick="closeNewReleases()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    // âš ï¸ é‡è¦: Google Apps Scriptã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå¾Œã€ä»¥ä¸‹ã®URLã‚’æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤URLã«æ›´æ–°ã—ã¦ãã ã•ã„
    // ãƒ‡ãƒ—ãƒ­ã‚¤URLå½¢å¼: https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec
    const apiUrl = 'https://script.google.com/macros/s/AKfycbx1wA6BtE7C5shRRJUntVi2xtvMhEwQb5Dk1OXhJ8PQfB3p9xy_S4SxVxXM_8vmydIV/exec';
    let currPage = 1;
    let totalPages = 1;
    let currIdx = null;
    let currentTag = null;
    let currentSearch = null;
    let currentSearchMethod = 'title'; // 'title' or 'imdb'

    // ===== Theme Switcher =====
    
    // Toggle theme dropdown menu
    function toggleThemeMenu() {
      const dropdown = document.getElementById('theme-dropdown');
      dropdown.classList.toggle('hidden');
    }
    
    // Close theme menu when clicking outside
    document.addEventListener('click', (e) => {
      const container = document.getElementById('theme-menu-container');
      const dropdown = document.getElementById('theme-dropdown');
      
      if (container && !container.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });
    
    // Select theme from dropdown
    function selectTheme(theme) {
      switchTheme(theme);
      
      // Close dropdown
      document.getElementById('theme-dropdown').classList.add('hidden');
    }
    
    function switchTheme(theme) {
      // Add animation class
      document.body.classList.add('theme-switching');
      
      // Update theme
      document.documentElement.setAttribute('data-theme', theme);
      
      // Update dropdown active state
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('active');
        if (option.dataset.theme === theme) {
          option.classList.add('active');
        }
      });
      
      // Save to localStorage
      localStorage.setItem('screenDeckTheme', theme);
      
      // Update theme-color meta tag
      const themeColors = {
        original: '#000000',
        appletv: '#000000',
        material: '#1C1B1F',
        neon: '#0a0e27',
        retro: '#1a0f0f',
        light: '#ffffff'
      };
      document.querySelector('meta[name="theme-color"]').setAttribute('content', themeColors[theme]);
      
      // Remove animation class
      setTimeout(() => {
        document.body.classList.remove('theme-switching');
      }, 300);
      
      console.log(`[Theme] Switched to: ${theme}`);
    }
    
    // Load saved theme on startup
    function loadSavedTheme() {
      const savedTheme = localStorage.getItem('screenDeckTheme') || 'original';
      switchTheme(savedTheme);
    }

    async function callAPI(action, params = {}) {
      const url = new URL(apiUrl);
      url.searchParams.append('action', action);
      for (const k in params) {
        url.searchParams.append(k, params[k]);
      }
      // URLã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦ã‹ã‚‰fetchã«æ¸¡ã™
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
      return await res.json();
    }

    async function loadPage(pg) {
      // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’ç¢ºå®Ÿã«æ•°å€¤ã«å¤‰æ›
      pg = parseInt(pg, 10);
      console.log('[Debug] loadPage called with page:', pg, 'type:', typeof pg);
      
      // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">Loading...</p>';
      
      // Prev/Nextãƒœã‚¿ãƒ³ã‚’ç¢ºå®Ÿã«è¡¨ç¤º
      document.getElementById('prev-btn').style.display = '';
      document.getElementById('next-btn').style.display = '';
      
      try {
        const data = await callAPI('loadPage', { page: pg });
        console.log('[Debug] API response received:', data);
        
        if (!data || !data.movies) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼</p>';
          return;
        }

        currPage = parseInt(data.page, 10);
        totalPages = parseInt(data.totalPages, 10);
        console.log('[Debug] Setting currPage to:', currPage, 'totalPages to:', totalPages);

        if (data.movies.length === 0) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">æ˜ ç”»ãŒã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }

        let html = '';
        for (const m of data.movies) {
          const watchedClass = m.isWatched ? 'watched' : '';
          html += `<div class="movie-card ${watchedClass}" data-row="${m.rowIndex}">`;
          html += `<img src="${m.poster}" alt="${m.titleJP}" class="w-full aspect-[2/3] object-cover">`;
          html += `<p class="truncate uppercase font-bold mt-3">${m.titleJP}</p>`;
          html += `<p class="silver-text mt-1">${m.year}</p></div>`;
        }
        grid.innerHTML = html;

        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });

        document.getElementById('page-indicator').innerText = `PAGE ${currPage}`;
        console.log('[Debug] Page indicator updated to: PAGE', currPage);
        
        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById('current-page-display').innerText = currPage;
        document.getElementById('total-pages-display').innerText = totalPages;
        
        document.getElementById('prev-btn').disabled = currPage <= 1;
        document.getElementById('next-btn').disabled = currPage >= totalPages;
      } catch(error) {
        console.error('[Debug] Error loading page:', error);
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    async function showDetail(row) {
      console.log('[Debug] showDetail called with row:', row);
      currIdx = row;
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      try {
        const data = await callAPI('getDetail', { rowIndex: row });
        console.log('[Debug] Detail data received:', data);
        
        if (!data || !data.movie) {
          alert('è©³ç´°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          closeModal();
          return;
        }

        const m = data.movie;
        document.getElementById('m-poster').src = m.poster || '';
        document.getElementById('m-title-jp').innerText = m.titleJP || '';
        document.getElementById('m-title-en').innerText = m.titleEN || '';
        document.getElementById('m-info').innerText = `${m.year || ''} Â· ${m.runtime || ''} Â· ${m.director || ''}`;
        document.getElementById('m-summary').innerText = m.summary || '';
        document.getElementById('m-comment').innerText = m.comment || '';
        
        // åˆæœŸå€¤ã‚’è¨­å®š
        document.getElementById('v-imdb').innerText = '--';
        document.getElementById('v-rt').innerText = '--';
        
        document.getElementById('l-imdb').href = `https://www.imdb.com/title/${m.imdbID}/`;
        document.getElementById('l-film').href = `https://filmarks.com/search?q=${encodeURIComponent(m.titleJP)}`;
        document.getElementById('l-emby').href = `http://wf-lhr-549.magicdust.ro:8096/web/index.html#!/search?query=${encodeURIComponent(m.titleEN)}&serverId=ba079bd2c9ab42c7ae1e5a1b4e74c04c`;
        
        const statusBadge = document.getElementById('status-badge');
        const toggleBtn = document.getElementById('toggle-status-btn');
        if (m.isWatched) {
          statusBadge.className = 'status-watched px-6 py-2 rounded-full text-xs font-bold uppercase';
          statusBadge.innerText = 'âœ“ è¦–è´æ¸ˆã¿';
          toggleBtn.innerText = 'æœªè¦–è´ã«æˆ»ã™';
        } else {
          statusBadge.className = 'status-unwatched px-6 py-2 rounded-full text-xs font-bold uppercase';
          statusBadge.innerText = 'æœªè¦–è´';
          toggleBtn.innerText = 'è¦–è´æ¸ˆã¿ã«ã™ã‚‹';
        }

        const tagContainer = document.getElementById('m-tags');
        tagContainer.innerHTML = '';
        if (m.tags && m.tags.length > 0) {
          for (const tag of m.tags) {
            const btn = document.createElement('button');
            btn.className = 'border-2 border-gray-700 hover:border-white hover:bg-white hover:text-black transition rounded-full px-5 py-2 text-sm font-bold';
            btn.innerText = '#' + tag;
            btn.onclick = (e) => {
              e.stopPropagation();
              closeModal();
              showMoviesByTag(tag);
            };
            tagContainer.appendChild(btn);
          }
        }
        
        // IMDb IDãŒå­˜åœ¨ã™ã‚‹å ´åˆã€è©•ä¾¡ã‚’å–å¾—
        if (m.imdbID && m.imdbID !== '' && m.imdbID !== 'N/A') {
          console.log('[Debug] Fetching ratings for IMDb ID:', m.imdbID);
          try {
            const ratings = await callAPI('getLiveRatings', { imdbId: m.imdbID });
            console.log('[Debug] Ratings received:', ratings);
            
            if (ratings && !ratings.error) {
              document.getElementById('v-imdb').innerText = ratings.imdb || 'N/A';
              document.getElementById('v-rt').innerText = ratings.rt || 'N/A';
            }
          } catch(ratingError) {
            console.error('[Debug] Error fetching ratings:', ratingError);
            // è©•ä¾¡å–å¾—ã«å¤±æ•—ã—ã¦ã‚‚è©³ç´°è¡¨ç¤ºã¯ç¶šè¡Œ
          }
        }
      } catch(error) {
        console.error('[Debug] Error fetching detail:', error);
        alert('Error: ' + error.message);
        closeModal();
      }
    }

    async function toggleStatus() {
      try {
        const result = await callAPI('toggleStatus', { rowIndex: currIdx });
        if (result.success) {
          showDetail(currIdx);
        } else {
          alert(result.error || 'Error');
        }
      } catch(error) {
        alert('Error: ' + error.message);
      }
    }

    async function submitAdd() {
      const val = document.getElementById('add-input').value.trim();
      if (!val) {
        alert(currentSearchMethod === 'title' ? 'æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' : 'IMDB IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: tt1234567ï¼‰');
        return;
      }

      const statusDiv = document.getElementById('reg-status');
      statusDiv.classList.remove('hidden');
      statusDiv.innerText = 'ç™»éŒ²ä¸­...';

      try {
        let result;
        if (currentSearchMethod === 'title') {
          result = await callAPI('addMovieByTitle', { title: val });
        } else {
          // IMDB IDæ¤œç´¢
          result = await callAPI('addMovieByImdbId', { imdbId: val });
        }
        
        if (result.success) {
          statusDiv.innerHTML = 'âœ… ' + result.message;
          setTimeout(() => {
            closeAdd();
            loadPage(currPage);
          }, 1500);
        } else {
          statusDiv.innerHTML = 'âŒ ' + (result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      } catch(error) {
        statusDiv.innerHTML = 'âŒ Error: ' + error.message;
      }
    }

    async function pickRandom(type) {
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">æ˜ ç”»ã‚’é¸ã‚“ã§ã„ã¾ã™...</p>';
      
      currentTag = null;
      currentSearch = null;
      document.getElementById('tag-filter').classList.add('hidden');
      document.getElementById('search-filter').classList.add('hidden');
      
      try {
        const data = await callAPI('pickRandom', { type });
        
        if (!data || !data.movie) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">æ˜ ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
          return;
        }
        
        showDetail(data.movie.rowIndex);
        loadPage(currPage);
      } catch(error) {
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    async function searchMovies(keyword) {
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">æ¤œç´¢ä¸­...</p>';
      
      currentTag = null;
      currentSearch = keyword;
      document.getElementById('tag-filter').classList.add('hidden');
      document.getElementById('search-filter').classList.remove('hidden');
      document.getElementById('current-search').innerText = keyword;
      
      try {
        const data = await callAPI('searchMovies', { keyword });
        
        if (!data.movies || data.movies.length === 0) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
          document.getElementById('search-count').innerText = '0';
          return;
        }
        
        document.getElementById('search-count').innerText = data.movies.length;
        
        let html = '';
        for (const m of data.movies) {
          const watchedClass = m.isWatched ? 'watched' : '';
          html += `<div class="movie-card ${watchedClass}" data-row="${m.rowIndex}">`;
          html += `<img src="${m.poster}" alt="${m.titleJP}" class="w-full aspect-[2/3] object-cover">`;
          html += `<p class="truncate uppercase font-bold mt-3">${m.titleJP}</p>`;
          html += `<p class="silver-text mt-1">${m.year}</p></div>`;
        }
        grid.innerHTML = html;
        
        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });
        
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
      } catch(error) {
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    async function showMoviesByTag(tag) {
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">èª­ã¿è¾¼ã¿ä¸­...</p>';
      
      currentTag = tag;
      currentSearch = null;
      document.getElementById('search-filter').classList.add('hidden');
      
      document.getElementById('tag-filter').classList.remove('hidden');
      document.getElementById('current-tag').innerText = '#' + tag;
      
      try {
        const data = await callAPI('getMoviesByTag', { tag });
        
        if (data.movies.length === 0) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">ã“ã®ã‚¿ã‚°ã®æ˜ ç”»ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }
        
        let html = '';
        for (const m of data.movies) {
          html += `<div class="movie-card" data-row="${m.rowIndex}">`;
          html += `<img src="${m.poster}" alt="${m.titleJP}" class="w-full aspect-[2/3] object-cover">`;
          html += `<p class="truncate uppercase font-bold mt-3">${m.titleJP}</p>`;
          html += `<p class="silver-text mt-1">${m.year}</p></div>`;
        }
        grid.innerHTML = html;
        
        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });
        
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
      } catch(error) {
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    // ===== UIåˆ¶å¾¡ =====
    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function openAdd() {
      document.getElementById('add-modal').classList.remove('hidden');
      document.getElementById('add-input').value = '';
      document.getElementById('add-input').focus();
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢
      setSearchMethod('title');
    }

    function closeAdd() {
      document.getElementById('add-modal').classList.add('hidden');
      document.getElementById('reg-status').classList.add('hidden');
    }

    function setSearchMethod(method) {
      currentSearchMethod = method;
      const titleBtn = document.getElementById('method-title');
      const imdbBtn = document.getElementById('method-imdb');
      const input = document.getElementById('add-input');
      
      if (method === 'title') {
        titleBtn.classList.add('active');
        imdbBtn.classList.remove('active');
        input.placeholder = 'æ˜ ç”»ã®æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›';
      } else {
        titleBtn.classList.remove('active');
        imdbBtn.classList.add('active');
        input.placeholder = 'IMDB IDã‚’å…¥åŠ›ï¼ˆä¾‹: tt1234567ï¼‰';
      }
      input.value = '';
      input.focus();
    }

    function openSearch() {
      document.getElementById('search-modal').classList.remove('hidden');
      document.getElementById('search-input').value = '';
      document.getElementById('search-input').focus();
    }

    function closeSearch() {
      document.getElementById('search-modal').classList.add('hidden');
    }

    function submitSearch() {
      const keyword = document.getElementById('search-input').value.trim();
      if (!keyword) {
        alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      closeSearch();
      searchMovies(keyword);
    }

    function clearTagFilter() {
      currentTag = null;
      currentSearch = null;
      document.getElementById('tag-filter').classList.add('hidden');
      document.getElementById('search-filter').classList.add('hidden');
      document.getElementById('prev-btn').style.display = '';
      document.getElementById('next-btn').style.display = '';
      loadPage(1);
    }

    async function editId() {
      const id = prompt('NEW IMDb ID (tt...):');
      if (id && id.trim()) {
        try {
          const result = await callAPI('updateMovieByImdbId', { rowIndex: currIdx, newId: id.trim() });
          alert(result.success ? result.message : result.error);
          if (result.success) showDetail(currIdx);
        } catch(error) {
          alert('Error: ' + error.message);
        }
      }
    }

    // ===== ãƒšãƒ¼ã‚¸ã‚¸ãƒ£ãƒ³ãƒ—æ©Ÿèƒ½ =====
    function openJumpModal() {
      console.log('[Jump] Opening jump modal');
      document.getElementById('jump-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // ç·ãƒšãƒ¼ã‚¸æ•°ã‚’è¡¨ç¤º
      document.getElementById('total-pages-display').textContent = totalPages;
      
      // å…¥åŠ›æ¬„ã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => {
        document.getElementById('jump-page-input').focus();
      }, 100);
    }
    
    function closeJumpModal() {
      document.getElementById('jump-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
      
      // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('jump-page-input').value = '';
    }
    
    function executeJump() {
      const input = document.getElementById('jump-page-input');
      const pageNum = parseInt(input.value);
      
      if (isNaN(pageNum) || pageNum < 1 || pageNum > totalPages) {
        alert(`1ã‹ã‚‰${totalPages}ã®é–“ã®ãƒšãƒ¼ã‚¸ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
        return;
      }
      
      console.log('[Jump] Jumping to page:', pageNum);
      
      closeJumpModal();
      loadPage(pageNum);
    }
    
    // ===== Help Modal =====
    function openHelp() {
      document.getElementById('help-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeHelp() {
      document.getElementById('help-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
    
    // ===== Export Functions =====
    function openExport() {
      document.getElementById('export-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeExport() {
      document.getElementById('export-modal').classList.add('hidden');
      document.getElementById('export-status').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
    
    // ===== New Releases Functions =====
    
    function openNewReleases() {
      document.getElementById('new-releases-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      loadNewReleases();
    }
    
    function closeNewReleases() {
      document.getElementById('new-releases-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
    
    async function loadNewReleases() {
      const statusDiv = document.getElementById('new-releases-status');
      const contentDiv = document.getElementById('new-releases-content');
      
      statusDiv.innerHTML = 'â³ æ–°è¦é…ä¿¡æƒ…å ±ã‚’å–å¾—ä¸­...';
      statusDiv.classList.remove('hidden');
      contentDiv.innerHTML = '';
      
      try {
        console.log('[New Releases] Calling API...');
        const data = await callAPI('getNewReleases', { days: 7 });
        console.log('[New Releases] API Response:', data);
        
        if (!data) {
          statusDiv.innerHTML = 'âŒ ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
          return;
        }
        
        if (!data.success) {
          statusDiv.innerHTML = `âŒ ${data.error || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
          console.error('[New Releases] Error:', data.error);
          return;
        }
        
        if (data.count === 0 || !data.releases || data.releases.length === 0) {
          statusDiv.innerHTML = 'ğŸ“­ éå»7æ—¥é–“ã®æ–°è¦é…ä¿¡ã¯ã‚ã‚Šã¾ã›ã‚“';
          return;
        }
        
        console.log('[New Releases] Total releases:', data.count);
        statusDiv.innerHTML = `âœ… ${data.count}ä½œå“ã®æ–°è¦é…ä¿¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;
        
        // ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const grouped = {};
        
        // ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‹ã‚‰åˆæœŸåŒ–
        if (data.services) {
          data.services.forEach(service => {
            grouped[service.key] = {
              name: service.name,
              color: service.color,
              icon: service.icon,
              releases: []
            };
          });
        }
        
        // ãƒªãƒªãƒ¼ã‚¹ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆé‡è¤‡é™¤å»ï¼‰
        const addedImdbIds = new Set();
        data.releases.forEach(release => {
          // IMDb IDã§é‡è¤‡ãƒã‚§ãƒƒã‚¯
          if (release.imdbId && !addedImdbIds.has(release.imdbId)) {
            addedImdbIds.add(release.imdbId);
            if (grouped[release.service]) {
              grouped[release.service].releases.push(release);
            }
          }
        });
        
        // å„ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        let sectionsRendered = 0;
        Object.entries(grouped).forEach(([serviceKey, serviceData]) => {
          if (serviceData.releases.length > 0) {
            console.log(`[New Releases] Rendering ${serviceData.name}: ${serviceData.releases.length} releases`);
            contentDiv.innerHTML += createServiceSection(
              serviceData.name,
              serviceData.releases,
              serviceData.color,
              serviceData.icon
            );
            sectionsRendered++;
          }
        });
        
        console.log('[New Releases] Sections rendered:', sectionsRendered);
        
        if (sectionsRendered === 0) {
          statusDiv.innerHTML = 'ğŸ“­ è¡¨ç¤ºã§ãã‚‹æ–°è¦é…ä¿¡ãŒã‚ã‚Šã¾ã›ã‚“';
        }
        
      } catch(error) {
        console.error('[New Releases] Exception:', error);
        statusDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
      }
    }
    
    function createServiceSection(serviceName, releases, color, icon) {
      let html = `
        <div class="service-section">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-2xl">${icon}</span>
            <div class="w-3 h-3 rounded-full" style="background: ${color}"></div>
            <h3 class="text-xl font-bold">${serviceName} (${releases.length})</h3>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
      `;
      
      releases.forEach(release => {
        const date = new Date(release.changeDate);
        const dateStr = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
        const ratingDisplay = release.rating ? `â­ ${release.rating}` : '';
        
        html += `
          <div class="release-card bg-gray-800 rounded-lg overflow-hidden hover:bg-gray-700 transition cursor-pointer" onclick="addMovieFromRelease('${release.imdbId}', '${escapeHtml(release.title)}')">
            ${release.poster ? `<img src="${release.poster}" alt="${escapeHtml(release.title)}" class="w-full aspect-[2/3] object-cover">` : '<div class="w-full aspect-[2/3] bg-gray-700 flex items-center justify-center text-4xl">ğŸ¬</div>'}
            <div class="p-3">
              <div class="flex items-center justify-between gap-2 mb-1">
                <span class="text-xs text-gray-400">${dateStr}</span>
                ${ratingDisplay ? `<span class="text-xs text-yellow-400">${ratingDisplay}</span>` : ''}
              </div>
              <div class="font-bold text-sm line-clamp-2">${escapeHtml(release.title)}</div>
              <div class="text-xs text-gray-400 mt-1">${release.year}</div>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
      
      return html;
    }
    
    async function addMovieFromRelease(imdbId, title) {
      if (!confirm(`ã€Œ${title}ã€ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }
      
      try {
        const statusDiv = document.getElementById('new-releases-status');
        statusDiv.innerHTML = 'â³ æ˜ ç”»ã‚’è¿½åŠ ä¸­...';
        
        const result = await callAPI('addMovie', { 
          title: imdbId, 
          method: 'imdb' 
        });
        
        if (result.success) {
          statusDiv.innerHTML = `âœ… ${title} ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`;
          setTimeout(() => {
            closeNewReleases();
            loadPage(1); // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
          }, 1500);
        } else {
          statusDiv.innerHTML = `âŒ ${result.error}`;
        }
      } catch(error) {
        console.error('[Add Movie] Error:', error);
        alert('æ˜ ç”»ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function exportData(format) {
      const statusDiv = document.getElementById('export-status');
      statusDiv.classList.remove('hidden');
      statusDiv.innerHTML = 'â³ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...';
      
      try {
        // ã™ã¹ã¦ã®æ˜ ç”»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const allMovies = await getAllMovies();
        
        if (!allMovies || allMovies.length === 0) {
          statusDiv.innerHTML = 'âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
          return;
        }
        
        statusDiv.innerHTML = `âœ… ${allMovies.length}ä»¶ã®æ˜ ç”»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`;
        
        // å½¢å¼ã«å¿œã˜ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        switch(format) {
          case 'csv':
            exportCSV(allMovies);
            break;
          case 'json':
            exportJSON(allMovies);
            break;
          case 'html':
            exportHTML(allMovies);
            break;
        }
        
        setTimeout(() => {
          statusDiv.innerHTML = 'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼';
          setTimeout(() => {
            closeExport();
          }, 1500);
        }, 500);
        
      } catch(error) {
        console.error('[Export] Error:', error);
        statusDiv.innerHTML = 'âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
      }
    }
    
    async function getAllMovies() {
      try {
        // ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const firstPage = await callAPI('loadPage', { page: 1 });
        const totalPages = firstPage.totalPages;
        
        let allMovies = [...firstPage.movies];
        
        // æ®‹ã‚Šã®ãƒšãƒ¼ã‚¸ã‚’å–å¾—
        for (let page = 2; page <= totalPages; page++) {
          const pageData = await callAPI('loadPage', { page });
          allMovies = allMovies.concat(pageData.movies);
        }
        
        return allMovies;
      } catch(error) {
        throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    function exportCSV(movies) {
      // CSVãƒ˜ãƒƒãƒ€ãƒ¼
      let csv = '\uFEFF'; // BOM for Excel UTF-8
      csv += 'æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«,è‹±èªã‚¿ã‚¤ãƒˆãƒ«,å…¬é–‹å¹´,ä¸Šæ˜ æ™‚é–“,ç›£ç£,IMDb ID,è¦–è´æ¸ˆã¿,ã‚³ãƒ¡ãƒ³ãƒˆ,ã‚¿ã‚°\n';
      
      // ãƒ‡ãƒ¼ã‚¿è¡Œ
      movies.forEach(movie => {
        const row = [
          escapeCSV(movie.titleJP || ''),
          escapeCSV(movie.titleEN || ''),
          escapeCSV(movie.year || ''),
          escapeCSV(movie.runtime || ''),
          escapeCSV(movie.director || ''),
          escapeCSV(movie.imdbID || ''),
          movie.isWatched ? 'âœ“' : '',
          escapeCSV(movie.comment || ''),
          escapeCSV((movie.tags || []).join(', '))
        ];
        csv += row.join(',') + '\n';
      });
      
      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      downloadFile(csv, 'screen-deck-movies.csv', 'text/csv;charset=utf-8;');
    }
    
    function escapeCSV(str) {
      if (str === null || str === undefined) return '';
      str = String(str);
      if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }
    
    function exportJSON(movies) {
      const json = JSON.stringify(movies, null, 2);
      downloadFile(json, 'screen-deck-movies.json', 'application/json');
    }
    
    function exportHTML(movies) {
      const currentTheme = localStorage.getItem('screenDeckTheme') || 'original';
      
      let html = `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Screen Deck - æ˜ ç”»ãƒªã‚¹ãƒˆ</title>
  <style>
    body {
      font-family: 'Arial', 'Helvetica', sans-serif;
      margin: 0;
      padding: 20px;
      background: #000;
      color: #fff;
    }
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 2px solid #333;
    }
    h1 {
      font-size: 36px;
      margin: 0 0 10px 0;
      letter-spacing: 2px;
    }
    .stats {
      color: #888;
      font-size: 14px;
    }
    .movie-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    .movie-card {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #333;
    }
    .movie-card.watched {
      border-color: #00be68;
      background: #0a1a0f;
    }
    .movie-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .movie-info {
      font-size: 12px;
      color: #888;
      margin-bottom: 3px;
    }
    .movie-tags {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .tag {
      background: #333;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
    }
    .watched-badge {
      display: inline-block;
      background: #00be68;
      color: #000;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 5px;
    }
    @media print {
      body { background: white; color: black; }
      .movie-card { background: #f5f5f5; border-color: #ddd; }
      .movie-card.watched { background: #e8f5e9; border-color: #4caf50; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>SCREEN DECK</h1>
    <div class="stats">
      å…¨${movies.length}ä½œå“ | 
      è¦–è´æ¸ˆã¿: ${movies.filter(m => m.isWatched).length}ä½œå“ | 
      æœªè¦–è´: ${movies.filter(m => !m.isWatched).length}ä½œå“ | 
      ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ—¥: ${new Date().toLocaleDateString('ja-JP')}
    </div>
  </div>
  
  <div class="movie-grid">`;
      
      movies.forEach(movie => {
        html += `
    <div class="movie-card ${movie.isWatched ? 'watched' : ''}">
      <div class="movie-title">
        ${escapeHTML(movie.titleJP || '')}
        ${movie.isWatched ? '<span class="watched-badge">âœ“</span>' : ''}
      </div>
      <div class="movie-info">${escapeHTML(movie.titleEN || '')}</div>
      <div class="movie-info">${escapeHTML(movie.year || '')} Â· ${escapeHTML(movie.runtime || '')}</div>
      <div class="movie-info">ç›£ç£: ${escapeHTML(movie.director || '')}</div>
      ${movie.comment ? `<div class="movie-info" style="margin-top: 8px; font-style: italic;">${escapeHTML(movie.comment)}</div>` : ''}
      ${movie.tags && movie.tags.length > 0 ? `
      <div class="movie-tags">
        ${movie.tags.map(tag => `<span class="tag">#${escapeHTML(tag)}</span>`).join('')}
      </div>` : ''}
    </div>`;
      });
      
      html += `
  </div>
</body>
</html>`;
      
      // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
      const printWindow = window.open('', '_blank');
      printWindow.document.write(html);
      printWindow.document.close();
    }
    
    function escapeHTML(str) {
      if (str === null || str === undefined) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // ===== åˆæœŸåŒ– =====
    window.onload = () => {
      console.log('[Debug] window.onload started');
      
      // Load saved theme first
      loadSavedTheme();
      
      loadPage(1);
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      document.getElementById('home-btn').onclick = clearTagFilter;
      document.getElementById('random-btn').onclick = () => pickRandom('all');
      document.getElementById('unwatched-btn').onclick = () => pickRandom('unwatched');
      document.getElementById('short-btn').onclick = () => pickRandom('short');
      document.getElementById('new-releases-btn').onclick = openNewReleases;
      document.getElementById('page-indicator').onclick = openJumpModal;
      console.log('[Debug] Page indicator listener attached');
      document.getElementById('search-btn').onclick = openSearch;
      document.getElementById('add-btn').onclick = openAdd;
      document.getElementById('export-btn').onclick = openExport;
      
      // Theme menu button
      document.getElementById('theme-menu-btn').onclick = (e) => {
        e.stopPropagation();
        toggleThemeMenu();
      };
      
      document.getElementById('prev-btn').onclick = () => loadPage(currPage - 1);
      document.getElementById('next-btn').onclick = () => loadPage(currPage + 1);
      document.getElementById('close-modal-btn').onclick = closeModal;
      document.getElementById('cancel-add-btn').onclick = closeAdd;
      document.getElementById('reg-btn').onclick = submitAdd;
      document.getElementById('edit-id-btn').onclick = editId;
      document.getElementById('toggle-status-btn').onclick = toggleStatus;
      document.getElementById('clear-tag').onclick = clearTagFilter;
      document.getElementById('cancel-search-btn').onclick = closeSearch;
      document.getElementById('search-submit-btn').onclick = submitSearch;
      document.getElementById('clear-search').onclick = clearTagFilter;
      document.getElementById('search-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') submitSearch();
      });

      // æ¤œç´¢æ–¹æ³•åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
      document.getElementById('method-title').onclick = () => setSearchMethod('title');
      document.getElementById('method-imdb').onclick = () => setSearchMethod('imdb');

      // ãƒšãƒ¼ã‚¸ã‚¸ãƒ£ãƒ³ãƒ—ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
      document.getElementById('close-jump-btn').onclick = closeJumpModal;
      document.getElementById('jump-execute-btn').onclick = executeJump;
      document.getElementById('jump-page-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') executeJump();
      });
      
      // ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³
      document.getElementById('help-btn').onclick = openHelp;
      
      console.log('[Debug] All event listeners attached successfully');
    };

    // ===== Keyboard Shortcuts =====
    document.addEventListener('keydown', (e) => {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹æ™‚ã®å‡¦ç†
      if (!document.getElementById('modal').classList.contains('hidden')) return;
      if (!document.getElementById('add-modal').classList.contains('hidden')) return;
      if (!document.getElementById('search-modal').classList.contains('hidden')) return;
      if (!document.getElementById('jump-modal').classList.contains('hidden')) return;
      if (!document.getElementById('export-modal').classList.contains('hidden')) {
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§Escã‚’æŠ¼ã—ãŸã‚‰é–‰ã˜ã‚‹
        if (e.key === 'Escape') {
          e.preventDefault();
          closeExport();
        }
        return;
      }
      if (!document.getElementById('help-modal').classList.contains('hidden')) {
        // ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã§Escã‚’æŠ¼ã—ãŸã‚‰é–‰ã˜ã‚‹
        if (e.key === 'Escape') {
          e.preventDefault();
          closeHelp();
        }
        return;
      }
      
      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹æ™‚ã¯ç„¡åŠ¹
      if (document.activeElement.tagName === 'INPUT') return;
      
      switch(e.key) {
        case 'ArrowLeft':
          // å‰ã®ãƒšãƒ¼ã‚¸
          if (currPage > 1) {
            e.preventDefault();
            loadPage(currPage - 1);
          }
          break;
        case 'ArrowRight':
          // æ¬¡ã®ãƒšãƒ¼ã‚¸
          if (currPage < totalPages) {
            e.preventDefault();
            loadPage(currPage + 1);
          }
          break;
        case '/':
          // æ¤œç´¢ã‚’é–‹ã
          e.preventDefault();
          openSearch();
          break;
        case '?':
          // ãƒ˜ãƒ«ãƒ—ã‚’é–‹ã
          e.preventDefault();
          openHelp();
          break;
        case 'Escape':
          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
          if (currentTag || currentSearch) {
            e.preventDefault();
            clearTagFilter();
          }
          break;
      }
    });

    // ===== Service Workerç™»éŒ² =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // sw.jsãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç™»éŒ²ã‚’è©¦ã¿ã‚‹
        fetch('sw.js', { method: 'HEAD' })
          .then(response => {
            if (response.ok) {
              navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('[PWA] Service Worker registered:', reg.scope))
                .catch(err => console.log('[PWA] Service Worker registration failed:', err));
            } else {
              console.log('[PWA] Service Worker file not found, skipping registration');
            }
          })
          .catch(() => {
            console.log('[PWA] Service Worker check failed, skipping registration');
          });
      });
    }
  </script>
</body>
</html>
