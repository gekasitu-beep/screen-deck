<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Screen Deck">
  <title>Screen Deck</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=1wXXnWU1jUCjajzlGiuNhP1kQxm53_9Lc">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      background-color: #000; 
      color: #fff; 
      font-family: 'Inter', sans-serif;
      overflow-x: hidden; 
    }
    h1, h2, h3, .title-font {
      font-family: 'Outfit', sans-serif;
      letter-spacing: -0.02em;
    }
    .display-font {
      font-family: 'Urbanist', sans-serif;
      letter-spacing: -0.01em;
    }
    .mono-font {
      font-family: 'Monaco', monospace;
      letter-spacing: 0.02em;
    }
    .movie-card { 
      transition: transform 0.3s ease;
      position: relative;
      cursor: pointer;
    }
    .movie-card:active { 
      transform: scale(0.95); 
    }
    @media (min-width: 768px) {
      .movie-card:hover { 
        transform: translateY(-5px); 
      }
    }
    .movie-card.watched::after {
      content: 'âœ“';
      position: absolute;
      top: 8px;
      right: 8px;
      background: #00be68;
      color: #000;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.6);
    }
    @media (min-width: 1024px) {
      .movie-card.watched::after {
        width: 28px;
        height: 28px;
        font-size: 16px;
        top: 6px;
        right: 6px;
      }
    }
    .movie-card img {
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.6);
    }
    .silver-text { color: #C0C0C0; }
    .glass-nav { 
      background: rgba(0, 0, 0, 0.95); 
      backdrop-filter: blur(10px); 
      border-bottom: 1px solid #222; 
    }
    .status-unwatched {
      background: rgba(255, 59, 48, 0.2);
      color: #ff3b30;
      border: 1px solid #ff3b30;
    }
    .status-watched {
      background: rgba(0, 190, 104, 0.2);
      color: #00be68;
      border: 1px solid #00be68;
    }
  </style>
</head>
<body class="pb-20">

  <nav class="glass-nav fixed top-0 w-full z-50 p-4 flex justify-between items-center flex-wrap gap-3">
    <div class="flex items-center gap-3 flex-wrap">
      <h1 class="font-black cursor-pointer title-font" style="font-size: 24px;" id="home-btn">SCREEN DECK</h1>
      <div class="flex gap-2 flex-wrap">
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="random-btn">ALL</button>
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="unwatched-btn">æœªè¦–è´</button>
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="short-btn">SHORT</button>
        <button class="border border-gray-700 rounded-full bg-white text-black hover:bg-gray-200 transition" style="font-size: 14px; padding: 8px 16px; font-weight: 700;" id="filter-btn">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</button>
        <button class="border border-gray-700 rounded-full bg-white text-black hover:bg-gray-200 transition" style="font-size: 14px; padding: 8px 16px; font-weight: 700;" id="search-btn">ğŸ” æ¤œç´¢</button>
        <button class="border border-gray-700 rounded-full bg-white text-black hover:bg-gray-200 transition" style="font-size: 14px; padding: 8px 16px; font-weight: 700;" id="add-btn">+ ADD</button>
      </div>
    </div>
    <div id="page-indicator" class="mono-font silver-text hidden sm:block" style="font-size: 12px;">PAGE 1</div>
  </nav>

  <main class="mt-32 px-2 sm:px-4 max-w-7xl mx-auto">
    <div id="tag-filter" class="mb-6 hidden">
      <div class="flex items-center justify-between">
        <p class="silver-text">ã‚¿ã‚°: <span id="current-tag" class="text-white font-bold"></span></p>
        <button id="clear-tag" class="text-gray-500 hover:text-white">âœ• ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <div id="search-filter" class="mb-6 hidden">
      <div class="flex items-center justify-between">
        <p class="silver-text">æ¤œç´¢: <span id="current-search" class="text-white font-bold"></span> (<span id="search-count" class="text-yellow-400"></span>ä»¶)</p>
        <button id="clear-search" class="text-gray-500 hover:text-white">âœ• ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    <div id="movie-grid" class="grid grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4 md:gap-6"></div>
    <div class="flex justify-center items-center gap-10 mt-16 mb-8">
      <button id="prev-btn" class="border border-gray-800 hover:bg-white hover:text-black transition font-bold px-6 py-3">Prev</button>
      <button id="next-btn" class="border border-gray-800 hover:bg-white hover:text-black transition font-bold px-6 py-3">Next</button>
    </div>
  </main>

  <div id="modal" class="fixed inset-0 z-[100] hidden bg-black overflow-y-auto">
    <div class="min-h-screen flex items-start justify-center">
      <div class="relative bg-gradient-to-b from-[#1a1a1a] to-[#0a0a0a] w-full min-h-screen overflow-y-auto">
        <button id="close-modal-btn" class="fixed top-5 right-5 w-16 h-16 flex items-center justify-center bg-black/80 hover:bg-white hover:text-black rounded-full z-50 transition text-3xl font-bold">âœ•</button>
        <div class="w-full bg-gradient-to-b from-gray-900 to-black flex items-center justify-center p-2 pt-12">
          <img id="m-poster" class="rounded-xl shadow-2xl w-full max-w-md" alt="Movie Poster">
        </div>
        <div class="w-full p-5 pb-24">
          <h2 id="m-title-jp" class="text-white mb-4 text-center title-font text-4xl font-black"></h2>
          <div class="flex justify-center mb-5">
            <span id="status-badge" class="px-6 py-2 rounded-full text-xs font-bold uppercase"></span>
          </div>
          <p id="m-title-en" class="silver-text italic mb-7 text-center text-xl"></p>
          <div id="m-info" class="mono-font silver-text mb-7 pb-7 border-b-2 border-gray-700 text-center"></div>
          <div class="grid grid-cols-2 gap-5 mb-7 bg-gradient-to-r from-gray-900/50 to-gray-800/50 p-6 rounded-2xl">
            <div class="text-center">
              <p class="text-gray-400 font-bold mb-3">IMDb</p>
              <p id="v-imdb" class="mono-font text-yellow-400 text-4xl font-bold">--</p>
            </div>
            <div class="text-center">
              <p class="text-gray-400 font-bold mb-3">RT</p>
              <p id="v-rt" class="mono-font text-red-400 text-4xl font-bold">--</p>
            </div>
          </div>
          <div class="bg-white/5 rounded-2xl p-6 mb-7 border-l-4 border-white">
            <p id="m-comment" class="italic text-gray-100 text-center text-lg"></p>
          </div>
          <p id="m-summary" class="text-gray-300 mb-7 text-center leading-relaxed"></p>
          <div id="m-tags" class="flex flex-wrap gap-4 mb-8 justify-center"></div>
          <div class="flex flex-col gap-4">
            <button id="toggle-status-btn" class="w-full border-2 border-green-600 hover:bg-green-600 text-white transition rounded-2xl py-4 font-bold">è¦–è´æ¸ˆã¿ã«ã™ã‚‹</button>
            <div class="grid grid-cols-2 gap-4">
              <a id="l-imdb" href="#" target="_blank" class="text-center border-2 border-yellow-600 hover:bg-yellow-600 text-white transition rounded-2xl py-3 font-bold">IMDb</a>
              <a id="l-film" href="#" target="_blank" class="text-center border-2 border-[#00be68] hover:bg-[#00be68] text-white transition rounded-2xl py-3 font-bold">Filmarks</a>
            </div>
            <button id="edit-id-btn" class="w-full text-gray-500 hover:text-white underline uppercase mt-3">Edit IMDb ID</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="add-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-sm">
      <h2 class="text-2xl font-black mb-8 uppercase">Add To Deck</h2>
      <input id="add-input" type="text" placeholder="ENTER JAPANESE TITLE" class="w-full bg-transparent border-b border-gray-700 p-4 text-center text-lg outline-none focus:border-white transition mb-8">
      <div class="flex justify-center gap-6">
        <button id="cancel-add-btn" class="text-xs silver-text uppercase">Cancel</button>
        <button id="reg-btn" class="text-xs bg-white text-black px-8 py-3 font-bold uppercase rounded-full">Register</button>
      </div>
      <p id="reg-status" class="mt-6 text-xs silver-text animate-pulse hidden uppercase">Processing...</p>
    </div>
  </div>

  <div id="search-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-md">
      <h2 class="text-3xl font-black mb-8 uppercase text-white">æ˜ ç”»ã‚’æ¤œç´¢</h2>
      <input id="search-input" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ç›£ç£åã§æ¤œç´¢" class="w-full bg-transparent border-b-2 border-purple-600 p-5 text-center text-xl outline-none focus:border-purple-400 transition mb-8 text-white">
      <div class="flex justify-center gap-6">
        <button id="cancel-search-btn" class="silver-text uppercase hover:text-white transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="search-submit-btn" class="bg-purple-600 text-white px-10 py-4 font-bold uppercase rounded-full hover:bg-purple-700 transition">æ¤œç´¢</button>
      </div>
    </div>
  </div>

  <div id="filter-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4">
    <div class="bg-gradient-to-b from-gray-900 to-black rounded-2xl p-8 w-full max-w-2xl border border-gray-800">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-3xl font-black uppercase text-white title-font">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
        <button id="close-filter-btn" class="text-gray-500 hover:text-white text-2xl">âœ•</button>
      </div>
      
      <div class="space-y-6">
        <!-- å¹´ä»£ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div>
          <label class="text-white font-bold mb-3 block">ğŸ“… å¹´ä»£</label>
          <div class="flex flex-wrap gap-2">
            <button class="filter-decade px-4 py-2 rounded-full border border-gray-700 bg-black hover:bg-white hover:text-black transition" data-decade="all">ã™ã¹ã¦</button>
            <button class="filter-decade px-4 py-2 rounded-full border border-gray-700 bg-black hover:bg-white hover:text-black transition" data-decade="2020">2020å¹´ä»£</button>
            <button class="filter-decade px-4 py-2 rounded-full border border-gray-700 bg-black hover:bg-white hover:text-black transition" data-decade="2010">2010å¹´ä»£</button>
            <button class="filter-decade px-4 py-2 rounded-full border border-gray-700 bg-black hover:bg-white hover:text-black transition" data-decade="2000">2000å¹´ä»£</button>
            <button class="filter-decade px-4 py-2 rounded-full border border-gray-700 bg-black hover:bg-white hover:text-black transition" data-decade="1990">1990å¹´ä»£</button>
            <button class="filter-decade px-4 py-2 rounded-full border border-gray-700 bg-black hover:bg-white hover:text-black transition" data-decade="1980">1980å¹´ä»£ä»¥å‰</button>
          </div>
        </div>

        <!-- ä¸Šæ˜ æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div>
          <label class="text-white font-bold mb-3 block">â±ï¸ ä¸Šæ˜ æ™‚é–“</label>
          <div class="flex flex-wrap gap-2">
            <button class="filter-runtime px-4 py-2 rounded-full border border-gray-700 bg-black hover:bg-white hover:text-black transition" data-runtime="all">ã™ã¹ã¦</button>
            <button class="filter-runtime px-4 py-2 rounded-full border border-gray-700 bg-black hover:bg-white hover:text-black transition" data-runtime="short">90åˆ†ä»¥ä¸‹</button>
            <button class="filter-runtime px-4 py-2 rounded-full border border-gray-700 bg-black hover:bg-white hover:text-black transition" data-runtime="medium">90-120åˆ†</button>
            <button class="filter-runtime px-4 py-2 rounded-full border border-gray-700 bg-black hover:bg-white hover:text-black transition" data-runtime="long">120åˆ†ä»¥ä¸Š</button>
          </div>
        </div>

        <!-- ã‚¹ãƒãƒ¼ãƒˆã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div>
          <label class="text-white font-bold mb-3 block">ğŸ·ï¸ ã‚¹ãƒãƒ¼ãƒˆã‚¿ã‚° <span class="text-xs text-gray-500">(TOP50)</span></label>
          <div id="smart-tags-container" class="flex flex-wrap gap-2 max-h-64 overflow-y-auto p-2 bg-black/30 rounded-lg">
            <p class="text-gray-500 text-sm">èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>
      </div>

      <div class="flex justify-center gap-4 mt-8">
        <button id="clear-filters-btn" class="px-8 py-3 border border-gray-700 rounded-full hover:bg-white hover:text-black transition font-bold">ã‚¯ãƒªã‚¢</button>
        <button id="apply-filters-btn" class="px-8 py-3 bg-white text-black rounded-full hover:bg-gray-200 transition font-bold">é©ç”¨</button>
      </div>

      <div id="filter-status" class="mt-4 text-center text-gray-400 text-sm"></div>
    </div>
  </div>

  <script>
    // ===== è¨­å®š =====
    const API_URL = 'https://script.google.com/macros/s/AKfycbwqnV0XAXzQoCrr4xlkpSFPh3t1fKRAaIilcna6Tsc2tP30lHNPdrC4Iic50RxfN7nu/exec';
    
    // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
    let currPage = 1;
    let currIdx = null;
    let currStatus = null;
    let totalPages = 1;
    let currentTag = null;
    let currentSearch = null;
    let currentFilters = {
      decade: 'all',
      runtime: 'all',
      tag: ''
    };
    let smartTags = [];
    let smartTagsCache = null; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let smartTagsLoading = false; // èª­ã¿è¾¼ã¿ä¸­ãƒ•ãƒ©ã‚°

    // ===== APIå‘¼ã³å‡ºã— =====
    async function callAPI(action, params = {}) {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action, ...params })
        });
        return await response.json();
      } catch(error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // ===== æ˜ ç”»ä¸€è¦§èª­ã¿è¾¼ã¿ =====
    async function loadPage(p) {
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text animate-pulse">Loading...</p>';
      
      try {
        const data = await callAPI('getMovies', { page: p });
        
        if (data.error) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + data.error + '</p>';
          return;
        }
        
        if (data.movies.length === 0) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">No movies found</p>';
          return;
        }
        
        let html = '';
        for (const m of data.movies) {
          const watchedClass = m.status === 'è¦–è´æ¸ˆã¿' || m.status === 'è¦–è´æ¸ˆ' ? ' watched' : '';
          html += `<div class="movie-card${watchedClass}" data-row="${m.rowIndex}">`;
          html += `<img src="${m.poster}" alt="${m.titleJP}" class="w-full aspect-[2/3] object-cover" loading="lazy">`;
          html += `<p class="truncate uppercase font-bold mt-3">${m.titleJP}</p>`;
          html += `<p class="silver-text mt-1">${m.year}</p></div>`;
        }
        grid.innerHTML = html;
        
        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });
        
        currPage = data.currentPage;
        totalPages = data.totalPages || 1;
        document.getElementById('page-indicator').innerText = 'PAGE ' + currPage + ' / ' + totalPages;
        
        document.getElementById('prev-btn').disabled = currPage === 1;
        document.getElementById('next-btn').disabled = currPage >= totalPages;
        
        window.scrollTo(0, 0);
      } catch(error) {
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    // ===== è©³ç´°è¡¨ç¤º =====
    async function showDetail(idx) {
      currIdx = idx;
      document.getElementById('modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      document.getElementById('v-imdb').innerText = '--';
      document.getElementById('v-rt').innerText = '--';
      
      try {
        const m = await callAPI('getMovieDetail', { rowIndex: idx });
        currStatus = m.status;
        
        document.getElementById('m-poster').src = m.poster;
        document.getElementById('m-title-jp').innerText = m.titleJP;
        document.getElementById('m-title-en').innerText = m.titleEN;
        document.getElementById('m-info').innerText = m.year + ' | ' + m.runtime + ' MIN | ' + m.director;
        document.getElementById('m-comment').innerText = m.aiComment;
        document.getElementById('m-summary').innerText = m.summary;
        document.getElementById('l-imdb').href = 'https://www.imdb.com/title/' + m.imdbId;
        document.getElementById('l-film').href = 'https://filmarks.com/search/movies?q=' + encodeURIComponent(m.titleJP);
        
        const badge = document.getElementById('status-badge');
        const toggleBtn = document.getElementById('toggle-status-btn');
        if (m.status === 'è¦–è´æ¸ˆã¿' || m.status === 'è¦–è´æ¸ˆ') {
          badge.innerText = 'è¦–è´æ¸ˆ';
          badge.className = 'status-badge status-watched px-6 py-2 rounded-full text-xs font-bold uppercase';
          toggleBtn.innerText = 'æœªè¦–è´ã«æˆ»ã™';
        } else {
          badge.innerText = 'æœªè¦–è´';
          badge.className = 'status-badge status-unwatched px-6 py-2 rounded-full text-xs font-bold uppercase';
          toggleBtn.innerText = 'è¦–è´æ¸ˆã¿ã«ã™ã‚‹';
        }
        
        let tagsHtml = '';
        for (const tag of m.tags) {
          tagsHtml += `<span class="bg-white/10 text-gray-300 px-4 py-2 rounded-full cursor-pointer hover:bg-white hover:text-black transition" data-tag="${tag.trim()}">#${tag.trim()}</span>`;
        }
        document.getElementById('m-tags').innerHTML = tagsHtml;
        
        document.querySelectorAll('[data-tag]').forEach(el => {
          el.onclick = () => {
            closeModal();
            loadMoviesByTag(el.dataset.tag);
          };
        });
        
        const ratings = await callAPI('getLiveRatings', { imdbId: m.imdbId });
        document.getElementById('v-imdb').innerText = ratings.imdb;
        document.getElementById('v-rt').innerText = ratings.rt;
      } catch(error) {
        alert('Error: ' + error.message);
        closeModal();
      }
    }

    // ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° =====
    async function toggleStatus() {
      const isWatched = currStatus === 'è¦–è´æ¸ˆã¿' || currStatus === 'è¦–è´æ¸ˆ';
      const newStatus = isWatched ? 'æœªè¦–è´' : 'è¦–è´æ¸ˆã¿';
      try {
        await callAPI('updateStatus', { rowIndex: currIdx, newStatus });
        currStatus = newStatus;
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closeModal();
        
        // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦æ›´æ–°ã‚’è¡¨ç¤º
        if (currentTag) {
          await loadMoviesByTag(currentTag);
        } else if (currentSearch) {
          await searchMovies(currentSearch);
        } else {
          await loadPage(currPage);
        }
      } catch(error) {
        alert('Error: ' + error.message);
      }
    }

    // ===== æ–°è¦è¿½åŠ  =====
    async function submitAdd() {
      const val = document.getElementById('add-input').value.trim();
      if (!val) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      document.getElementById('reg-btn').disabled = true;
      document.getElementById('reg-status').classList.remove('hidden');
      
      try {
        const result = await callAPI('addNewMovie', { title: val });
        alert(result.success ? result.message : result.error);
        closeAdd();
        loadPage(1);
      } catch(error) {
        alert('Error: ' + error.message);
      } finally {
        document.getElementById('reg-btn').disabled = false;
        document.getElementById('reg-status').classList.add('hidden');
      }
    }

    // ===== ãƒ©ãƒ³ãƒ€ãƒ é¸å‡º =====
    async function pickRandom(mode) {
      try {
        const result = await callAPI('getRandomMovie', { mode });
        if (result.rowIndex) {
          showDetail(result.rowIndex);
        } else {
          alert('æ¡ä»¶ã«åˆã†æ˜ ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        }
      } catch(error) {
        alert('Error: ' + error.message);
      }
    }

    // ===== æ¤œç´¢ =====
    async function searchMovies(keyword) {
      currentSearch = keyword;
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text animate-pulse">Searching...</p>';
      
      document.getElementById('search-filter').classList.remove('hidden');
      document.getElementById('current-search').innerText = '"' + keyword + '"';
      
      try {
        const data = await callAPI('searchMovies', { keyword });
        
        document.getElementById('search-count').innerText = data.count || 0;
        
        if (data.movies.length === 0) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">è©²å½“ã™ã‚‹æ˜ ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
          return;
        }
        
        let html = '';
        for (const m of data.movies) {
          const watchedClass = m.status === 'è¦–è´æ¸ˆã¿' || m.status === 'è¦–è´æ¸ˆ' ? ' watched' : '';
          html += `<div class="movie-card${watchedClass}" data-row="${m.rowIndex}">`;
          html += `<img src="${m.poster}" alt="${m.titleJP}" class="w-full aspect-[2/3] object-cover">`;
          html += `<p class="truncate uppercase font-bold mt-3">${m.titleJP}</p>`;
          html += `<p class="silver-text mt-1">${m.year}</p></div>`;
        }
        grid.innerHTML = html;
        
        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });
        
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
      } catch(error) {
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    // ===== ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ =====
    async function loadMoviesByTag(tag) {
      currentTag = tag;
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text animate-pulse">Loading...</p>';
      
      document.getElementById('tag-filter').classList.remove('hidden');
      document.getElementById('current-tag').innerText = '#' + tag;
      
      try {
        const data = await callAPI('getMoviesByTag', { tag });
        
        if (data.movies.length === 0) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">ã“ã®ã‚¿ã‚°ã®æ˜ ç”»ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }
        
        let html = '';
        for (const m of data.movies) {
          html += `<div class="movie-card" data-row="${m.rowIndex}">`;
          html += `<img src="${m.poster}" alt="${m.titleJP}" class="w-full aspect-[2/3] object-cover">`;
          html += `<p class="truncate uppercase font-bold mt-3">${m.titleJP}</p>`;
          html += `<p class="silver-text mt-1">${m.year}</p></div>`;
        }
        grid.innerHTML = html;
        
        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });
        
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
      } catch(error) {
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    // ===== UIåˆ¶å¾¡ =====
    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function openAdd() {
      document.getElementById('add-modal').classList.remove('hidden');
      document.getElementById('add-input').value = '';
      document.getElementById('add-input').focus();
    }

    function closeAdd() {
      document.getElementById('add-modal').classList.add('hidden');
      document.getElementById('reg-status').classList.add('hidden');
    }

    function openSearch() {
      document.getElementById('search-modal').classList.remove('hidden');
      document.getElementById('search-input').value = '';
      document.getElementById('search-input').focus();
    }

    function closeSearch() {
      document.getElementById('search-modal').classList.add('hidden');
    }

    function submitSearch() {
      const keyword = document.getElementById('search-input').value.trim();
      if (!keyword) {
        alert('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      closeSearch();
      searchMovies(keyword);
    }

    function clearTagFilter() {
      currentTag = null;
      currentSearch = null;
      document.getElementById('tag-filter').classList.add('hidden');
      document.getElementById('search-filter').classList.add('hidden');
      document.getElementById('prev-btn').style.display = '';
      document.getElementById('next-btn').style.display = '';
      loadPage(1);
    }

    async function editId() {
      const id = prompt('NEW IMDb ID (tt...):');
      if (id && id.trim()) {
        try {
          const result = await callAPI('updateMovieByImdbId', { rowIndex: currIdx, newId: id.trim() });
          alert(result.success ? result.message : result.error);
          if (result.success) showDetail(currIdx);
        } catch(error) {
          alert('Error: ' + error.message);
        }
      }
    }

    // ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ =====
    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¹ãƒãƒ¼ãƒˆã‚¿ã‚°ã‚’èª­ã¿è¾¼ã¿
    async function loadSmartTagsInBackground() {
      if (smartTagsLoading || smartTagsCache) {
        return; // æ—¢ã«èª­ã¿è¾¼ã¿ä¸­ã€ã¾ãŸã¯å®Œäº†ã—ã¦ã„ã‚‹
      }
      
      console.log('[Background] Starting smart tags loading...');
      await updateSmartTags();
      console.log('[Background] Smart tags loaded and cached');
    }
    
    async function openFilterModal() {
      console.log('[Debug] openFilterModal called');
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ï¼ˆå³åº§ã«è¡¨ç¤ºï¼‰
      if (smartTagsCache) {
        console.log('[Debug] Using cached smart tags');
        displaySmartTags(smartTagsCache);
      } else if (smartTagsLoading) {
        // èª­ã¿è¾¼ã¿ä¸­
        document.getElementById('smart-tags-container').innerHTML = '<p class="text-gray-500 text-sm">ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
      } else {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ãªãã€èª­ã¿è¾¼ã¿ã‚‚é–‹å§‹ã—ã¦ã„ãªã„å ´åˆã¯ä»Šã‹ã‚‰èª­ã¿è¾¼ã¿
        console.log('[Debug] No cache, loading now...');
        await updateSmartTags();
      }
      
      // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’åæ˜ 
      document.querySelectorAll('.filter-decade').forEach(btn => {
        if (btn.dataset.decade === currentFilters.decade) {
          btn.classList.add('bg-white', 'text-black');
          btn.classList.remove('bg-black');
        } else {
          btn.classList.remove('bg-white', 'text-black');
          btn.classList.add('bg-black');
        }
      });
      
      document.querySelectorAll('.filter-runtime').forEach(btn => {
        if (btn.dataset.runtime === currentFilters.runtime) {
          btn.classList.add('bg-white', 'text-black');
          btn.classList.remove('bg-black');
        } else {
          btn.classList.remove('bg-white', 'text-black');
          btn.classList.add('bg-black');
        }
      });
      
      // é¸æŠä¸­ã®ã‚¿ã‚°ã‚’åæ˜ 
      document.querySelectorAll('.smart-tag-btn').forEach(btn => {
        if (btn.dataset.tag === currentFilters.tag) {
          btn.classList.add('bg-purple-600', 'text-white');
          btn.classList.remove('bg-black');
        } else {
          btn.classList.remove('bg-purple-600', 'text-white');
          btn.classList.add('bg-black');
        }
      });
      
      document.getElementById('filter-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      console.log('[Debug] Modal display set:', document.getElementById('filter-modal').classList.contains('hidden'));
      console.log('[Debug] Modal element:', document.getElementById('filter-modal'));
    }

    function closeFilterModal() {
      document.getElementById('filter-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    async function updateSmartTags() {
      try {
        smartTagsLoading = true;
        const container = document.getElementById('smart-tags-container');
        container.innerHTML = '<p class="text-gray-500 text-sm">ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
        
        console.log('[Debug] Starting smart tags collection...');
        
        // ã‚¿ã‚°ã®å‡ºç¾å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        const tagCount = {};
        
        // å…¨ãƒšãƒ¼ã‚¸ã‚’å–å¾—
        const firstPage = await callAPI('getMovies', { page: 1 });
        const pages = firstPage.totalPages || 1;
        
        console.log(`[Debug] Total pages: ${pages}`);
        
        let processedMovies = 0;
        const totalMovies = (firstPage.totalMovies || 0);
        
        for (let page = 1; page <= pages; page++) {
          const data = await callAPI('getMovies', { page });
          if (data.movies) {
            for (const movie of data.movies) {
              try {
                const detail = await callAPI('getMovieDetail', { rowIndex: movie.rowIndex });
                if (detail.tags && detail.tags.length > 0) {
                  detail.tags.forEach(tag => {
                    const trimmedTag = tag.trim();
                    if (trimmedTag) {
                      tagCount[trimmedTag] = (tagCount[trimmedTag] || 0) + 1;
                    }
                  });
                }
                processedMovies++;
                
                // é€²æ—ã‚’è¡¨ç¤º
                if (processedMovies % 5 === 0) {
                  container.innerHTML = `<p class="text-gray-500 text-sm">ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­... ${processedMovies} / ${totalMovies}</p>`;
                }
              } catch(e) {
                // ã‚¹ã‚­ãƒƒãƒ—
              }
            }
          }
        }
        
        console.log('[Debug] Tag collection complete');
        
        // å‡ºç¾å›æ•°ã§ã‚½ãƒ¼ãƒˆã—ã¦TOP50ã‚’å–å¾—
        const sortedTags = Object.entries(tagCount)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 50);
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        smartTagsCache = sortedTags;
        smartTags = sortedTags;
        smartTagsLoading = false;
        
        console.log(`[Debug] Cached ${sortedTags.length} tags`);
        
        // è¡¨ç¤º
        displaySmartTags(sortedTags);
        
      } catch(error) {
        console.error('[Debug] Smart tags error:', error);
        smartTagsLoading = false;
        document.getElementById('smart-tags-container').innerHTML = '<p class="text-red-500 text-sm">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
      }
    }

    function displaySmartTags(sortedTags) {
      const container = document.getElementById('smart-tags-container');
      
      if (sortedTags.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">ã‚¿ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
        return;
      }
      
      // ã‚¿ã‚°ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
      let html = '';
      sortedTags.forEach(([tag, count]) => {
        html += `<button class="smart-tag-btn px-3 py-2 rounded-full border border-gray-700 bg-black hover:bg-purple-600 hover:text-white transition text-sm" data-tag="${tag}">${tag} <span class="text-gray-500 text-xs">(${count})</span></button>`;
      });
      
      container.innerHTML = html;
      
      // ã‚¿ã‚°ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      document.querySelectorAll('.smart-tag-btn').forEach(btn => {
        btn.onclick = () => {
          // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è§£é™¤
          if (currentFilters.tag === btn.dataset.tag) {
            currentFilters.tag = '';
            btn.classList.remove('bg-purple-600', 'text-white');
            btn.classList.add('bg-black');
          } else {
            // ä»–ã®ã‚¿ã‚°ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.smart-tag-btn').forEach(b => {
              b.classList.remove('bg-purple-600', 'text-white');
              b.classList.add('bg-black');
            });
            // æ–°ã—ã„ã‚¿ã‚°ã‚’é¸æŠ
            currentFilters.tag = btn.dataset.tag;
            btn.classList.add('bg-purple-600', 'text-white');
            btn.classList.remove('bg-black');
          }
        };
      });
    }

    async function applyFilters() {
      try {
        document.getElementById('filter-status').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
        
        const allMovies = [];
        const firstPage = await callAPI('getMovies', { page: 1 });
        const pages = firstPage.totalPages || 1;
        
        for (let page = 1; page <= pages; page++) {
          const data = await callAPI('getMovies', { page });
          if (data.movies) {
            for (const movie of data.movies) {
              const detail = await callAPI('getMovieDetail', { rowIndex: movie.rowIndex });
              allMovies.push({
                ...movie,
                director: detail.director,
                runtime: parseInt(detail.runtime) || 0,
                tags: detail.tags || []
              });
            }
          }
        }
        
        let filtered = allMovies;
        
        // å¹´ä»£ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (currentFilters.decade !== 'all') {
          filtered = filtered.filter(m => {
            const year = parseInt(m.year);
            if (isNaN(year)) return false;
            
            if (currentFilters.decade === '1980') {
              return year < 1990;
            } else {
              const decadeStart = parseInt(currentFilters.decade);
              return year >= decadeStart && year < decadeStart + 10;
            }
          });
        }
        
        // ä¸Šæ˜ æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (currentFilters.runtime !== 'all') {
          filtered = filtered.filter(m => {
            if (m.runtime === 0) return false;
            
            if (currentFilters.runtime === 'short') {
              return m.runtime <= 90;
            } else if (currentFilters.runtime === 'medium') {
              return m.runtime > 90 && m.runtime <= 120;
            } else if (currentFilters.runtime === 'long') {
              return m.runtime > 120;
            }
            return true;
          });
        }
        
        // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (currentFilters.tag) {
          filtered = filtered.filter(m => {
            return m.tags && m.tags.includes(currentFilters.tag);
          });
        }
        
        displayFilteredMovies(filtered);
        closeFilterModal();
        
      } catch(error) {
        console.error('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('filter-status').textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      }
    }

    function displayFilteredMovies(movies) {
      const grid = document.getElementById('movie-grid');
      
      if (movies.length === 0) {
        grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">æ¡ä»¶ã«åˆã†æ˜ ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        return;
      }
      
      let html = '';
      for (const m of movies) {
        const watchedClass = m.status === 'è¦–è´æ¸ˆã¿' || m.status === 'è¦–è´æ¸ˆ' ? ' watched' : '';
        html += `<div class="movie-card${watchedClass}" data-row="${m.rowIndex}">`;
        html += `<img src="${m.poster}" alt="${m.titleJP}" class="w-full aspect-[2/3] object-cover">`;
        html += `<p class="truncate uppercase font-bold mt-3">${m.titleJP}</p>`;
        html += `<p class="silver-text mt-1">${m.year}</p></div>`;
      }
      grid.innerHTML = html;
      
      document.querySelectorAll('.movie-card').forEach(card => {
        card.onclick = () => showDetail(parseInt(card.dataset.row));
      });
      
      document.getElementById('prev-btn').style.display = 'none';
      document.getElementById('next-btn').style.display = 'none';
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤º
      const filterInfo = [];
      if (currentFilters.decade !== 'all') {
        const decadeLabel = currentFilters.decade === '1980' ? '1980å¹´ä»£ä»¥å‰' : `${currentFilters.decade}å¹´ä»£`;
        filterInfo.push(decadeLabel);
      }
      if (currentFilters.runtime !== 'all') {
        const runtimeLabel = {
          'short': '90åˆ†ä»¥ä¸‹',
          'medium': '90-120åˆ†',
          'long': '120åˆ†ä»¥ä¸Š'
        }[currentFilters.runtime];
        filterInfo.push(runtimeLabel);
      }
      if (currentFilters.tag) {
        filterInfo.push(`ã‚¿ã‚°: ${currentFilters.tag}`);
      }
      
      if (filterInfo.length > 0) {
        const statusDiv = document.createElement('div');
        statusDiv.id = 'filter-info-bar';
        statusDiv.className = 'mb-6 flex items-center justify-between';
        statusDiv.innerHTML = `
          <p class="silver-text">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼: <span class="text-white font-bold">${filterInfo.join(' / ')}</span> (<span class="text-yellow-400">${movies.length}ä»¶</span>)</p>
          <button id="clear-all-filters" class="text-gray-500 hover:text-white">âœ• ã‚¯ãƒªã‚¢</button>
        `;
        grid.parentElement.insertBefore(statusDiv, grid);
        
        document.getElementById('clear-all-filters').onclick = clearAllFilters;
      }
    }

    function clearAllFilters() {
      currentFilters = {
        decade: 'all',
        runtime: 'all',
        tag: ''
      };
      loadPage(1);
      
      const statusDiv = document.getElementById('filter-info-bar');
      if (statusDiv) statusDiv.remove();
    }

    // ===== åˆæœŸåŒ– =====
    window.onload = () => {
      console.log('[Debug] window.onload started');
      loadPage(1);
      
      // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¹ãƒãƒ¼ãƒˆã‚¿ã‚°ã‚’èª­ã¿è¾¼ã¿é–‹å§‹
      setTimeout(() => {
        loadSmartTagsInBackground();
      }, 2000); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œ2ç§’å¾…ã£ã¦ã‹ã‚‰é–‹å§‹
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      document.getElementById('home-btn').onclick = clearTagFilter;
      document.getElementById('random-btn').onclick = () => pickRandom('all');
      document.getElementById('unwatched-btn').onclick = () => pickRandom('unwatched');
      document.getElementById('short-btn').onclick = () => pickRandom('short');
      document.getElementById('filter-btn').onclick = openFilterModal;
      console.log('[Debug] Filter button listener attached');
      document.getElementById('search-btn').onclick = openSearch;
      document.getElementById('add-btn').onclick = openAdd;
      document.getElementById('prev-btn').onclick = () => loadPage(currPage - 1);
      document.getElementById('next-btn').onclick = () => loadPage(currPage + 1);
      document.getElementById('close-modal-btn').onclick = closeModal;
      document.getElementById('cancel-add-btn').onclick = closeAdd;
      document.getElementById('reg-btn').onclick = submitAdd;
      document.getElementById('edit-id-btn').onclick = editId;
      document.getElementById('toggle-status-btn').onclick = toggleStatus;
      document.getElementById('clear-tag').onclick = clearTagFilter;
      document.getElementById('cancel-search-btn').onclick = closeSearch;
      document.getElementById('search-submit-btn').onclick = submitSearch;
      document.getElementById('clear-search').onclick = clearTagFilter;
      document.getElementById('search-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') submitSearch();
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
      document.getElementById('close-filter-btn').onclick = closeFilterModal;
      document.getElementById('apply-filters-btn').onclick = applyFilters;
      document.getElementById('clear-filters-btn').onclick = () => {
        currentFilters = {
          decade: 'all',
          runtime: 'all',
          tag: ''
        };
        document.querySelectorAll('.filter-decade, .filter-runtime').forEach(btn => {
          if (btn.dataset.decade === 'all' || btn.dataset.runtime === 'all') {
            btn.classList.add('bg-white', 'text-black');
            btn.classList.remove('bg-black');
          } else {
            btn.classList.remove('bg-white', 'text-black');
            btn.classList.add('bg-black');
          }
        });
        document.querySelectorAll('.smart-tag-btn').forEach(btn => {
          btn.classList.remove('bg-purple-600', 'text-white');
          btn.classList.add('bg-black');
        });
      };
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      document.querySelectorAll('.filter-decade').forEach(btn => {
        btn.onclick = () => {
          currentFilters.decade = btn.dataset.decade;
          document.querySelectorAll('.filter-decade').forEach(b => {
            b.classList.remove('bg-white', 'text-black');
            b.classList.add('bg-black');
          });
          btn.classList.add('bg-white', 'text-black');
          btn.classList.remove('bg-black');
        };
      });
      
      document.querySelectorAll('.filter-runtime').forEach(btn => {
        btn.onclick = () => {
          currentFilters.runtime = btn.dataset.runtime;
          document.querySelectorAll('.filter-runtime').forEach(b => {
            b.classList.remove('bg-white', 'text-black');
            b.classList.add('bg-black');
          });
          btn.classList.add('bg-white', 'text-black');
          btn.classList.remove('bg-black');
        };
      });
      
      console.log('[Debug] All event listeners attached successfully');
    };

    // ===== Service Workerç™»éŒ² =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('[PWA] Service Worker registered:', reg.scope))
          .catch(err => console.log('[PWA] Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
