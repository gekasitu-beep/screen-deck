<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Screen Deck">
  <title>Screen Deck</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="https://drive.google.com/uc?export=view&id=1wXXnWU1jUCjajzlGiuNhP1kQxm53_9Lc">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=Inter:wght@400;500;600;700&family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      background-color: #000; 
      color: #fff; 
      font-family: 'Inter', sans-serif;
      overflow-x: hidden; 
    }
    h1, h2, h3, .title-font {
      font-family: 'Outfit', sans-serif;
      letter-spacing: -0.02em;
    }
    .display-font {
      font-family: 'Urbanist', sans-serif;
      letter-spacing: -0.01em;
    }
    .mono-font {
      font-family: 'Monaco', monospace;
      letter-spacing: 0.02em;
    }
    .movie-card { 
      transition: transform 0.3s ease;
      position: relative;
      cursor: pointer;
    }
    .movie-card:active { 
      transform: scale(0.95); 
    }
    @media (min-width: 768px) {
      .movie-card:hover { 
        transform: translateY(-5px); 
      }
    }
    .movie-card.watched::after {
      content: '‚úì';
      position: absolute;
      top: 8px;
      right: 8px;
      background: #00be68;
      color: #000;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.6);
    }
    @media (min-width: 1024px) {
      .movie-card.watched::after {
        width: 28px;
        height: 28px;
        font-size: 16px;
        top: 6px;
        right: 6px;
      }
    }
    .movie-card img {
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.6);
    }
    .silver-text { color: #C0C0C0; }
    .glass-nav { 
      background: rgba(0, 0, 0, 0.95); 
      backdrop-filter: blur(10px); 
      border-bottom: 1px solid #222; 
    }
    .status-unwatched {
      background: rgba(255, 59, 48, 0.2);
      color: #ff3b30;
      border: 1px solid #ff3b30;
    }
    .status-watched {
      background: rgba(0, 190, 104, 0.2);
      color: #00be68;
      border: 1px solid #00be68;
    }
    .search-method-btn {
      transition: all 0.2s ease;
    }
    .search-method-btn.active {
      background: white;
      color: black;
    }
  </style>
</head>
<body class="pb-20">

  <nav class="glass-nav fixed top-0 w-full z-50 p-4 flex justify-between items-center flex-wrap gap-3">
    <div class="flex items-center gap-3 flex-wrap">
      <h1 class="font-black cursor-pointer title-font" style="font-size: 24px;" id="home-btn">SCREEN DECK</h1>
      <div class="flex gap-2 flex-wrap">
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="random-btn">ALL</button>
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="unwatched-btn">Êú™Ë¶ñËÅ¥</button>
        <button class="border border-gray-700 rounded-full bg-black hover:bg-white hover:text-black transition" style="font-size: 14px; padding: 8px 16px; font-weight: 600;" id="short-btn">SHORT</button>
        <button class="border border-gray-700 rounded-full bg-white text-black hover:bg-gray-200 transition" style="font-size: 14px; padding: 8px 16px; font-weight: 700;" id="search-btn">üîç Ê§úÁ¥¢</button>
        <button class="border border-gray-700 rounded-full bg-white text-black hover:bg-gray-200 transition" style="font-size: 14px; padding: 8px 16px; font-weight: 700;" id="add-btn">+ ADD</button>
      </div>
    </div>
    <div id="page-indicator" class="mono-font silver-text cursor-pointer hover:text-white transition text-xs sm:text-sm" title="„ÇØ„É™„ÉÉ„ÇØ„Åß„Éö„Éº„Ç∏„Ç∏„É£„É≥„Éó">PAGE 1</div>
  </nav>

  <main class="mt-32 px-2 sm:px-4 max-w-7xl mx-auto">
    <div id="tag-filter" class="mb-6 hidden">
      <div class="flex items-center justify-between">
        <p class="silver-text">„Çø„Ç∞: <span id="current-tag" class="text-white font-bold"></span></p>
        <button id="clear-tag" class="text-gray-500 hover:text-white">‚úï „ÇØ„É™„Ç¢</button>
      </div>
    </div>
    <div id="search-filter" class="mb-6 hidden">
      <div class="flex items-center justify-between">
        <p class="silver-text">Ê§úÁ¥¢: <span id="current-search" class="text-white font-bold"></span> (<span id="search-count" class="text-yellow-400"></span>‰ª∂)</p>
        <button id="clear-search" class="text-gray-500 hover:text-white">‚úï „ÇØ„É™„Ç¢</button>
      </div>
    </div>
    <div id="movie-grid" class="grid grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4 md:gap-6"></div>
    <div class="flex justify-center items-center gap-10 mt-16 mb-8">
      <button id="prev-btn" class="border border-gray-800 hover:bg-white hover:text-black transition font-bold px-6 py-3">Prev</button>
      <button id="next-btn" class="border border-gray-800 hover:bg-white hover:text-black transition font-bold px-6 py-3">Next</button>
    </div>
  </main>

  <div id="modal" class="fixed inset-0 z-[100] hidden bg-black overflow-y-auto">
    <div class="min-h-screen flex items-start justify-center">
      <div class="relative bg-gradient-to-b from-[#1a1a1a] to-[#0a0a0a] w-full min-h-screen overflow-y-auto">
        <button id="close-modal-btn" class="fixed top-5 right-5 w-16 h-16 flex items-center justify-center bg-black/80 hover:bg-white hover:text-black rounded-full z-50 transition text-3xl font-bold">‚úï</button>
        <div class="w-full bg-gradient-to-b from-gray-900 to-black flex items-center justify-center p-2 pt-12">
          <img id="m-poster" class="rounded-xl shadow-2xl w-full max-w-md" alt="Movie Poster">
        </div>
        <div class="w-full p-5 pb-24">
          <h2 id="m-title-jp" class="text-white mb-4 text-center title-font text-4xl font-black"></h2>
          <div class="flex justify-center mb-5">
            <span id="status-badge" class="px-6 py-2 rounded-full text-xs font-bold uppercase"></span>
          </div>
          <p id="m-title-en" class="silver-text italic mb-7 text-center text-xl"></p>
          <div id="m-info" class="mono-font silver-text mb-7 pb-7 border-b-2 border-gray-700 text-center"></div>
          <div class="grid grid-cols-2 gap-5 mb-7 bg-gradient-to-r from-gray-900/50 to-gray-800/50 p-6 rounded-2xl">
            <div class="text-center">
              <p class="text-gray-400 font-bold mb-3">IMDb</p>
              <p id="v-imdb" class="mono-font text-yellow-400 text-4xl font-bold">--</p>
            </div>
            <div class="text-center">
              <p class="text-gray-400 font-bold mb-3">RT</p>
              <p id="v-rt" class="mono-font text-red-400 text-4xl font-bold">--</p>
            </div>
          </div>
          <div class="bg-white/5 rounded-2xl p-6 mb-7 border-l-4 border-white">
            <p id="m-comment" class="italic text-gray-100 text-center text-lg"></p>
          </div>
          <p id="m-summary" class="text-gray-300 mb-7 text-center leading-relaxed"></p>
          <div id="m-tags" class="flex flex-wrap gap-4 mb-8 justify-center"></div>
          
          <div class="flex flex-col gap-4">
            <button id="toggle-status-btn" class="w-full border-2 border-green-600 hover:bg-green-600 text-white transition rounded-2xl py-4 font-bold">Ë¶ñËÅ¥Ê∏à„Åø„Å´„Åô„Çã</button>
            <div class="grid grid-cols-3 gap-3">
              <a id="l-imdb" href="#" target="_blank" class="text-center border-2 border-yellow-600 hover:bg-yellow-600 text-white transition rounded-2xl py-3 font-bold text-sm">IMDb</a>
              <a id="l-film" href="#" target="_blank" class="text-center border-2 border-[#00be68] hover:bg-[#00be68] text-white transition rounded-2xl py-3 font-bold text-sm">Filmarks</a>
              <a id="l-emby" href="#" target="_blank" class="text-center border-2 border-blue-600 hover:bg-blue-600 text-white transition rounded-2xl py-3 font-bold text-sm">EMBY</a>
            </div>
            <button id="edit-id-btn" class="w-full text-gray-500 hover:text-white underline uppercase mt-3">Edit IMDb ID</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="add-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-sm">
      <h2 class="text-2xl font-black mb-8 uppercase">Add To Deck</h2>
      
      <!-- Ê§úÁ¥¢ÊñπÊ≥ïÈÅ∏Êäû„Éú„Çø„É≥ -->
      <div class="flex gap-2 mb-6 justify-center">
        <button id="method-title" class="search-method-btn active border border-gray-600 rounded-full px-6 py-2 font-bold text-sm">Êó•Êú¨Ë™û„Çø„Ç§„Éà„É´</button>
        <button id="method-imdb" class="search-method-btn border border-gray-600 rounded-full px-6 py-2 font-bold text-sm">IMDB ID</button>
      </div>
      
      <input id="add-input" type="text" placeholder="Êò†Áîª„ÅÆÊó•Êú¨Ë™û„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ" class="w-full p-4 mb-6 rounded-2xl bg-gray-900 border-2 border-gray-700 text-white focus:outline-none focus:border-white">
      <div class="flex gap-4">
        <button id="cancel-add-btn" class="flex-1 border-2 border-gray-600 hover:bg-gray-600 text-white transition rounded-2xl py-3 font-bold">Cancel</button>
        <button id="reg-btn" class="flex-1 border-2 border-white hover:bg-white hover:text-black text-white transition rounded-2xl py-3 font-bold">Register</button>
      </div>
      <div id="reg-status" class="mt-6 p-4 bg-gray-900/70 rounded-2xl border border-gray-700 hidden"></div>
    </div>
  </div>

  <div id="search-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-sm">
      <h2 class="text-2xl font-black mb-8 uppercase">Search Deck</h2>
      <input id="search-input" type="text" placeholder="Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ" class="w-full p-4 mb-6 rounded-2xl bg-gray-900 border-2 border-gray-700 text-white focus:outline-none focus:border-white">
      <div class="flex gap-4">
        <button id="cancel-search-btn" class="flex-1 border-2 border-gray-600 hover:bg-gray-600 text-white transition rounded-2xl py-3 font-bold">Cancel</button>
        <button id="search-submit-btn" class="flex-1 border-2 border-white hover:bg-white hover:text-black text-white transition rounded-2xl py-3 font-bold">Search</button>
      </div>
    </div>
  </div>

  <div id="jump-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur flex items-center justify-center p-4 text-center">
    <div class="w-full max-w-sm">
      <h2 class="text-2xl font-black mb-4 uppercase">Jump to Page</h2>
      <p class="text-gray-400 mb-8">Total Pages: <span id="total-pages-display" class="text-white font-bold">--</span></p>
      <input id="jump-page-input" type="number" min="1" placeholder="„Éö„Éº„Ç∏Áï™Âè∑" class="w-full p-4 mb-6 rounded-2xl bg-gray-900 border-2 border-gray-700 text-white focus:outline-none focus:border-white text-center text-xl">
      <div class="flex gap-4">
        <button id="close-jump-btn" class="flex-1 border-2 border-gray-600 hover:bg-gray-600 text-white transition rounded-2xl py-3 font-bold">Cancel</button>
        <button id="jump-execute-btn" class="flex-1 border-2 border-white hover:bg-white hover:text-black text-white transition rounded-2xl py-3 font-bold">GO</button>
      </div>
    </div>
  </div>

  <script>
    // ‚ö†Ô∏è ÈáçË¶Å: Google Apps Script„ÇíÂÜç„Éá„Éó„É≠„Ç§„Åó„ÅüÂæå„ÄÅ‰ª•‰∏ã„ÅÆURL„ÇíÊñ∞„Åó„ÅÑ„Éá„Éó„É≠„Ç§URL„Å´Êõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ
    // „Éá„Éó„É≠„Ç§URLÂΩ¢Âºè: https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec
    const apiUrl = 'https://script.google.com/macros/s/AKfycbwP3g0QYhg43Zaus78DlvO6Pj585kuHJXarHthvwbYWPRmU_XLNDxQTyI1wwuqamwuV/exec';
    let currPage = 1;
    let totalPages = 1;
    let currIdx = null;
    let currentTag = null;
    let currentSearch = null;
    let currentSearchMethod = 'title'; // 'title' or 'imdb'

    async function callAPI(action, params = {}) {
      const url = new URL(apiUrl);
      url.searchParams.append('action', action);
      for (const k in params) {
        url.searchParams.append(k, params[k]);
      }
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
      return await res.json();
    }

    async function loadPage(pg) {
      console.log('[Debug] loadPage called with page:', pg);
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">Loading...</p>';
      
      try {
        const data = await callAPI('loadPage', { page: pg });
        console.log('[Debug] API response received:', data);
        
        if (!data || !data.movies) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº</p>';
          return;
        }

        currPage = data.page;
        totalPages = data.totalPages;
        console.log('[Debug] Setting totalPages to:', totalPages);

        if (data.movies.length === 0) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">Êò†Áîª„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
          return;
        }

        let html = '';
        for (const m of data.movies) {
          const watchedClass = m.isWatched ? 'watched' : '';
          html += `<div class="movie-card ${watchedClass}" data-row="${m.rowIndex}">`;
          html += `<img src="${m.poster}" alt="${m.titleJP}" class="w-full aspect-[2/3] object-cover">`;
          html += `<p class="truncate uppercase font-bold mt-3">${m.titleJP}</p>`;
          html += `<p class="silver-text mt-1">${m.year}</p></div>`;
        }
        grid.innerHTML = html;

        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });

        document.getElementById('page-indicator').innerText = `PAGE ${currPage}`;
        console.log('[Debug] Page indicator updated to: PAGE', currPage);
        document.getElementById('prev-btn').disabled = currPage <= 1;
        document.getElementById('next-btn').disabled = currPage >= totalPages;
      } catch(error) {
        console.error('[Debug] Error loading page:', error);
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    async function showDetail(row) {
      console.log('[Debug] showDetail called with row:', row);
      currIdx = row;
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      try {
        const data = await callAPI('getDetail', { rowIndex: row });
        console.log('[Debug] Detail data received:', data);
        
        if (!data || !data.movie) {
          alert('Ë©≥Á¥∞ÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          closeModal();
          return;
        }

        const m = data.movie;
        document.getElementById('m-poster').src = m.poster || '';
        document.getElementById('m-title-jp').innerText = m.titleJP || '';
        document.getElementById('m-title-en').innerText = m.titleEN || '';
        document.getElementById('m-info').innerText = `${m.year || ''} ¬∑ ${m.runtime || ''} ¬∑ ${m.director || ''}`;
        document.getElementById('m-summary').innerText = m.summary || '';
        document.getElementById('m-comment').innerText = m.comment || '';
        
        // ÂàùÊúüÂÄ§„ÇíË®≠ÂÆö
        document.getElementById('v-imdb').innerText = '--';
        document.getElementById('v-rt').innerText = '--';
        
        document.getElementById('l-imdb').href = `https://www.imdb.com/title/${m.imdbID}/`;
        document.getElementById('l-film').href = `https://filmarks.com/search?q=${encodeURIComponent(m.titleJP)}`;
        document.getElementById('l-emby').href = `http://wf-lhr-549.magicdust.ro:8096/web/index.html#!/search?query=${encodeURIComponent(m.titleEN)}&serverId=ba079bd2c9ab42c7ae1e5a1b4e74c04c`;
        
        const statusBadge = document.getElementById('status-badge');
        const toggleBtn = document.getElementById('toggle-status-btn');
        if (m.isWatched) {
          statusBadge.className = 'status-watched px-6 py-2 rounded-full text-xs font-bold uppercase';
          statusBadge.innerText = '‚úì Ë¶ñËÅ¥Ê∏à„Åø';
          toggleBtn.innerText = 'Êú™Ë¶ñËÅ¥„Å´Êàª„Åô';
        } else {
          statusBadge.className = 'status-unwatched px-6 py-2 rounded-full text-xs font-bold uppercase';
          statusBadge.innerText = 'Êú™Ë¶ñËÅ¥';
          toggleBtn.innerText = 'Ë¶ñËÅ¥Ê∏à„Åø„Å´„Åô„Çã';
        }

        const tagContainer = document.getElementById('m-tags');
        tagContainer.innerHTML = '';
        if (m.tags && m.tags.length > 0) {
          for (const tag of m.tags) {
            const btn = document.createElement('button');
            btn.className = 'border-2 border-gray-700 hover:border-white hover:bg-white hover:text-black transition rounded-full px-5 py-2 text-sm font-bold';
            btn.innerText = '#' + tag;
            btn.onclick = (e) => {
              e.stopPropagation();
              closeModal();
              showMoviesByTag(tag);
            };
            tagContainer.appendChild(btn);
          }
        }
        
        // IMDb ID„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÄÅË©ï‰æ°„ÇíÂèñÂæó
        if (m.imdbID && m.imdbID !== '' && m.imdbID !== 'N/A') {
          console.log('[Debug] Fetching ratings for IMDb ID:', m.imdbID);
          try {
            const ratings = await callAPI('getLiveRatings', { imdbId: m.imdbID });
            console.log('[Debug] Ratings received:', ratings);
            
            if (ratings && !ratings.error) {
              document.getElementById('v-imdb').innerText = ratings.imdb || 'N/A';
              document.getElementById('v-rt').innerText = ratings.rt || 'N/A';
            }
          } catch(ratingError) {
            console.error('[Debug] Error fetching ratings:', ratingError);
            // Ë©ï‰æ°ÂèñÂæó„Å´Â§±Êïó„Åó„Å¶„ÇÇË©≥Á¥∞Ë°®Á§∫„ÅØÁ∂öË°å
          }
        }
      } catch(error) {
        console.error('[Debug] Error fetching detail:', error);
        alert('Error: ' + error.message);
        closeModal();
      }
    }

    async function toggleStatus() {
      try {
        const result = await callAPI('toggleStatus', { rowIndex: currIdx });
        if (result.success) {
          showDetail(currIdx);
        } else {
          alert(result.error || 'Error');
        }
      } catch(error) {
        alert('Error: ' + error.message);
      }
    }

    async function submitAdd() {
      const val = document.getElementById('add-input').value.trim();
      if (!val) {
        alert(currentSearchMethod === 'title' ? 'Êó•Êú¨Ë™û„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ' : 'IMDB ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æã: tt1234567Ôºâ');
        return;
      }

      const statusDiv = document.getElementById('reg-status');
      statusDiv.classList.remove('hidden');
      statusDiv.innerText = 'ÁôªÈå≤‰∏≠...';

      try {
        let result;
        if (currentSearchMethod === 'title') {
          result = await callAPI('addMovieByTitle', { title: val });
        } else {
          // IMDB IDÊ§úÁ¥¢
          result = await callAPI('addMovieByImdbId', { imdbId: val });
        }
        
        if (result.success) {
          statusDiv.innerHTML = '‚úÖ ' + result.message;
          setTimeout(() => {
            closeAdd();
            loadPage(currPage);
          }, 1500);
        } else {
          statusDiv.innerHTML = '‚ùå ' + (result.error || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        }
      } catch(error) {
        statusDiv.innerHTML = '‚ùå Error: ' + error.message;
      }
    }

    async function pickRandom(type) {
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">Êò†Áîª„ÇíÈÅ∏„Çì„Åß„ÅÑ„Åæ„Åô...</p>';
      
      currentTag = null;
      currentSearch = null;
      document.getElementById('tag-filter').classList.add('hidden');
      document.getElementById('search-filter').classList.add('hidden');
      
      try {
        const data = await callAPI('pickRandom', { type });
        
        if (!data || !data.movie) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Êò†Áîª„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>';
          return;
        }
        
        showDetail(data.movie.rowIndex);
        loadPage(currPage);
      } catch(error) {
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    async function searchMovies(keyword) {
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">Ê§úÁ¥¢‰∏≠...</p>';
      
      currentTag = null;
      currentSearch = keyword;
      document.getElementById('tag-filter').classList.add('hidden');
      document.getElementById('search-filter').classList.remove('hidden');
      document.getElementById('current-search').innerText = keyword;
      
      try {
        const data = await callAPI('searchMovies', { keyword });
        
        if (!data.movies || data.movies.length === 0) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
          document.getElementById('search-count').innerText = '0';
          return;
        }
        
        document.getElementById('search-count').innerText = data.movies.length;
        
        let html = '';
        for (const m of data.movies) {
          const watchedClass = m.isWatched ? 'watched' : '';
          html += `<div class="movie-card ${watchedClass}" data-row="${m.rowIndex}">`;
          html += `<img src="${m.poster}" alt="${m.titleJP}" class="w-full aspect-[2/3] object-cover">`;
          html += `<p class="truncate uppercase font-bold mt-3">${m.titleJP}</p>`;
          html += `<p class="silver-text mt-1">${m.year}</p></div>`;
        }
        grid.innerHTML = html;
        
        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });
        
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
      } catch(error) {
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    async function showMoviesByTag(tag) {
      const grid = document.getElementById('movie-grid');
      grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">Ë™≠„ÅøËæº„Åø‰∏≠...</p>';
      
      currentTag = tag;
      currentSearch = null;
      document.getElementById('search-filter').classList.add('hidden');
      
      document.getElementById('tag-filter').classList.remove('hidden');
      document.getElementById('current-tag').innerText = '#' + tag;
      
      try {
        const data = await callAPI('getMoviesByTag', { tag });
        
        if (data.movies.length === 0) {
          grid.innerHTML = '<p class="col-span-full text-center py-20 silver-text">„Åì„ÅÆ„Çø„Ç∞„ÅÆÊò†Áîª„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
          return;
        }
        
        let html = '';
        for (const m of data.movies) {
          html += `<div class="movie-card" data-row="${m.rowIndex}">`;
          html += `<img src="${m.poster}" alt="${m.titleJP}" class="w-full aspect-[2/3] object-cover">`;
          html += `<p class="truncate uppercase font-bold mt-3">${m.titleJP}</p>`;
          html += `<p class="silver-text mt-1">${m.year}</p></div>`;
        }
        grid.innerHTML = html;
        
        document.querySelectorAll('.movie-card').forEach(card => {
          card.onclick = () => showDetail(parseInt(card.dataset.row));
        });
        
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
      } catch(error) {
        grid.innerHTML = '<p class="col-span-full text-center py-20 text-red-500">Error: ' + error.message + '</p>';
      }
    }

    // ===== UIÂà∂Âæ° =====
    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function openAdd() {
      document.getElementById('add-modal').classList.remove('hidden');
      document.getElementById('add-input').value = '';
      document.getElementById('add-input').focus();
      // „Éá„Éï„Ç©„É´„Éà„ÅØÊó•Êú¨Ë™û„Çø„Ç§„Éà„É´Ê§úÁ¥¢
      setSearchMethod('title');
    }

    function closeAdd() {
      document.getElementById('add-modal').classList.add('hidden');
      document.getElementById('reg-status').classList.add('hidden');
    }

    function setSearchMethod(method) {
      currentSearchMethod = method;
      const titleBtn = document.getElementById('method-title');
      const imdbBtn = document.getElementById('method-imdb');
      const input = document.getElementById('add-input');
      
      if (method === 'title') {
        titleBtn.classList.add('active');
        imdbBtn.classList.remove('active');
        input.placeholder = 'Êò†Áîª„ÅÆÊó•Êú¨Ë™û„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ';
      } else {
        titleBtn.classList.remove('active');
        imdbBtn.classList.add('active');
        input.placeholder = 'IMDB ID„ÇíÂÖ•ÂäõÔºà‰æã: tt1234567Ôºâ';
      }
      input.value = '';
      input.focus();
    }

    function openSearch() {
      document.getElementById('search-modal').classList.remove('hidden');
      document.getElementById('search-input').value = '';
      document.getElementById('search-input').focus();
    }

    function closeSearch() {
      document.getElementById('search-modal').classList.add('hidden');
    }

    function submitSearch() {
      const keyword = document.getElementById('search-input').value.trim();
      if (!keyword) {
        alert('Ê§úÁ¥¢„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      closeSearch();
      searchMovies(keyword);
    }

    function clearTagFilter() {
      currentTag = null;
      currentSearch = null;
      document.getElementById('tag-filter').classList.add('hidden');
      document.getElementById('search-filter').classList.add('hidden');
      document.getElementById('prev-btn').style.display = '';
      document.getElementById('next-btn').style.display = '';
      loadPage(1);
    }

    async function editId() {
      const id = prompt('NEW IMDb ID (tt...):');
      if (id && id.trim()) {
        try {
          const result = await callAPI('updateMovieByImdbId', { rowIndex: currIdx, newId: id.trim() });
          alert(result.success ? result.message : result.error);
          if (result.success) showDetail(currIdx);
        } catch(error) {
          alert('Error: ' + error.message);
        }
      }
    }

    // ===== „Éö„Éº„Ç∏„Ç∏„É£„É≥„ÉóÊ©üËÉΩ =====
    function openJumpModal() {
      console.log('[Jump] Opening jump modal');
      document.getElementById('jump-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // Á∑è„Éö„Éº„Ç∏Êï∞„ÇíË°®Á§∫
      document.getElementById('total-pages-display').textContent = totalPages;
      
      // ÂÖ•ÂäõÊ¨Ñ„Çí„Éï„Ç©„Éº„Ç´„Çπ
      setTimeout(() => {
        document.getElementById('jump-page-input').focus();
      }, 100);
    }
    
    function closeJumpModal() {
      document.getElementById('jump-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
      
      // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
      document.getElementById('jump-page-input').value = '';
    }
    
    function executeJump() {
      const input = document.getElementById('jump-page-input');
      const pageNum = parseInt(input.value);
      
      if (isNaN(pageNum) || pageNum < 1 || pageNum > totalPages) {
        alert(`1„Åã„Çâ${totalPages}„ÅÆÈñì„ÅÆ„Éö„Éº„Ç∏Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`);
        return;
      }
      
      console.log('[Jump] Jumping to page:', pageNum);
      
      closeJumpModal();
      loadPage(pageNum);
    }

    // ===== ÂàùÊúüÂåñ =====
    window.onload = () => {
      console.log('[Debug] window.onload started');
      loadPage(1);
      
      // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
      document.getElementById('home-btn').onclick = clearTagFilter;
      document.getElementById('random-btn').onclick = () => pickRandom('all');
      document.getElementById('unwatched-btn').onclick = () => pickRandom('unwatched');
      document.getElementById('short-btn').onclick = () => pickRandom('short');
      document.getElementById('page-indicator').onclick = openJumpModal;
      console.log('[Debug] Page indicator listener attached');
      document.getElementById('search-btn').onclick = openSearch;
      document.getElementById('add-btn').onclick = openAdd;
      document.getElementById('prev-btn').onclick = () => loadPage(currPage - 1);
      document.getElementById('next-btn').onclick = () => loadPage(currPage + 1);
      document.getElementById('close-modal-btn').onclick = closeModal;
      document.getElementById('cancel-add-btn').onclick = closeAdd;
      document.getElementById('reg-btn').onclick = submitAdd;
      document.getElementById('edit-id-btn').onclick = editId;
      document.getElementById('toggle-status-btn').onclick = toggleStatus;
      document.getElementById('clear-tag').onclick = clearTagFilter;
      document.getElementById('cancel-search-btn').onclick = closeSearch;
      document.getElementById('search-submit-btn').onclick = submitSearch;
      document.getElementById('clear-search').onclick = clearTagFilter;
      document.getElementById('search-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') submitSearch();
      });

      // Ê§úÁ¥¢ÊñπÊ≥ïÂàá„ÇäÊõø„Åà„Éú„Çø„É≥
      document.getElementById('method-title').onclick = () => setSearchMethod('title');
      document.getElementById('method-imdb').onclick = () => setSearchMethod('imdb');

      // „Éö„Éº„Ç∏„Ç∏„É£„É≥„Éó„Ç≥„É≥„Éà„É≠„Éº„É´
      document.getElementById('close-jump-btn').onclick = closeJumpModal;
      document.getElementById('jump-execute-btn').onclick = executeJump;
      document.getElementById('jump-page-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') executeJump();
      });
      
      console.log('[Debug] All event listeners attached successfully');
    };

    // ===== Service WorkerÁôªÈå≤ =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('[PWA] Service Worker registered:', reg.scope))
          .catch(err => console.log('[PWA] Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
